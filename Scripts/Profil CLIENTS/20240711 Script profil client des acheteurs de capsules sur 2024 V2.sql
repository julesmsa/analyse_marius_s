---- Etablir le profil client des acheteurs de capsules sur 2024

SET dtdeb = Date('2024-01-01');
SET dtfin = DAte('2024-06-30'); 

SET dtdeb_KH = Date('2024-01-29');
SET dtfin_KH = DAte('2024-02-25'); 

SET dtdeb_PK = Date('2024-03-25');
SET dtfin_PK = DAte('2024-04-21'); 

SET dtdeb_music = Date('2024-04-29');
SET dtfin_music = DAte('2024-05-26'); 

SET dtdeb_smiley = Date('2024-05-27');
SET dtfin_smiley = DAte('2024-06-30');

SET ENSEIGNE1 = 1; -- renseigner ici les différentes enseignes et pays. Renseigner tous les paramètres, quitte à utiliser une valeur qui n'existe pas
SET ENSEIGNE2 = 3;
SET PAYS1 = 'FRA'; --code_pays = 'FRA' ... 
SET PAYS2 = 'BEL'; --code_pays = 'BEL' 

select $dtdeb, $dtfin, $PAYS1, $PAYS2, $ENSEIGNE1, $ENSEIGNE2;

CREATE OR REPLACE TEMPORARY TABLE DATA_MESH_PROD_CLIENT.WORK.BASE_INFOCLT_CAPSULES AS
WITH info_clt AS ( SELECT DISTINCT Code_client AS idclient, id_titre, date_naissance, age, gender, 
est_valide_telephone, est_optin_sms_com, est_optin_sms_fid, est_optin_email_com, 
est_optin_email_fid, code_postal, code_pays AS pays_clt, date_recrutement, recense, id_macro_segment, lib_macro_segment, lib_segment_omni
FROM DATA_MESH_PROD_client.SHARED.T_CLIENT_DENORMALISEE WHERE (code_pays = $PAYS1 or code_pays = $PAYS2) AND date_suppression_client IS NULL ),
produit as (
    select distinct ref.ID_REFERENCE, ref.ID_FAMILLE_ACHAT, fam.LIB_FAMILLE_ACHAT,
        G.LIB_GROUPE_FAMILLE
    from DATA_MESH_PROD_OFFRE.HUB.DMD_PRD_REFERENCE ref
    join DATA_MESH_PROD_OFFRE.HUB.DMD_PRD_FAMILLE_ACHAT fam 
        on ref.ID_FAMILLE_ACHAT = fam.ID_FAMILLE_ACHAT
    INNER JOIN DATA_MESH_PROD_OFFRE.HUB.DMD_PRD_GROUPE_FAMILLE_ACHAT G
        ON G.ID_GROUPE_FAMILLE = fam.id_groupe_famille
    where ref.est_version_courante = 1 and ref.id_marque = 'JUL'),
Magasin AS (
SELECT DISTINCT ID_ORG_ENSEIGNE, ID_MAGASIN, type_emplacement,code_magasin, lib_magasin, lib_statut, id_concept, lib_enseigne,code_pays, 
CASE WHEN type_emplacement IN ('EC','MP') THEN 'WEB'
WHEN type_emplacement IN ('PAC','CC', 'CV','CCV') THEN 'MAG' END AS PERIMETRE
FROM DATA_MESH_PROD_RETAIL.HUB.DMD_MAGASIN
WHERE ID_ORG_ENSEIGNE = $ENSEIGNE1 or ID_ORG_ENSEIGNE = $ENSEIGNE2),
tickets as (
Select   vd.CODE_CLIENT,
vd.ID_ORG_ENSEIGNE, vd.ID_MAGASIN AS mag_achat, vd.CODE_MAGASIN, vd.CODE_CAISSE, vd.CODE_DATE_TICKET, vd.CODE_TICKET, vd.date_ticket, 
vd.MONTANT_TTC,
vd.code_ligne, vd.type_ligne, vd.libelle_type_ligne, 
vd.code_type_article, vd.code_ligne_taille, vd.code_grille_taille, vd.code_coloris, vd.CODE_REFERENCE, vd.code_marque,
CONCAT(vd.CODE_REFERENCE,vd.CODE_COLORIS) AS REFCO,
vd.prix_unitaire, vd.montant_remise, 
vd.QUANTITE_LIGNE,
vd.MONTANT_MARGE_SORTIE,
vd.libelle_type_ticket, 
vd.id_ticket, 
mag.type_emplacement, mag.code_magasin AS code_mag, mag.lib_magasin, mag.lib_statut, mag.id_concept, mag.lib_enseigne, mag.code_pays,
vd.LIB_FAMILLE_ACHAT,
CASE WHEN 
CONCAT(vd.CODE_REFERENCE,vd.CODE_COLORIS) IN ('100504214800','100504310000','100517918000','100504710000','100504718000','100543310028')
and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH)
THEN 1 ELSE 0 END AS refco_KHARING, 
CASE WHEN 
CONCAT(vd.CODE_REFERENCE,vd.CODE_COLORIS) IN
('100588111550','100588310019','100588418000','100588510141','100585618018','100585710141','100585811846','100585919400')
and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK)
THEN 1 ELSE 0 END AS refco_PolaKodak, 
CASE WHEN 
CONCAT(vd.CODE_REFERENCE,vd.CODE_COLORIS) IN
('100588914451','100589410141','100589510141','100589218838','100588818460','100589310141','100599018460','100599118000','100599218460')
and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music)
THEN 1 ELSE 0 END AS refco_music, 
CASE WHEN 
CONCAT(vd.CODE_REFERENCE,vd.CODE_COLORIS) IN
('100530619800','100528510021','100556916342','100558416034','100558318129','100557319600','100558219800','100533319800','100527716616','100561310141',
'100527610141','100543410141','100558118129','100557418129','100557410141','100563219600','100558519800','100558516653','100530710141','100561516034')
and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley)
THEN 1 ELSE 0 END AS refco_smiley,
CASE WHEN 
CONCAT(vd.CODE_REFERENCE,vd.CODE_COLORIS) IN ('100504214800','100504310000','100517918000','100504710000','100504718000','100543310028')
THEN '01-refco_KHARING' 
WHEN 
CONCAT(vd.CODE_REFERENCE,vd.CODE_COLORIS) IN
('100588111550','100588310019','100588418000','100588510141','100585618018','100585710141','100585811846','100585919400')
THEN '02-refco_PolaKodak' 
WHEN 
CONCAT(vd.CODE_REFERENCE,vd.CODE_COLORIS) IN
('100588914451','100589410141','100589510141','100589218838','100588818460','100589310141','100599018460','100599118000','100599218460')
THEN '03-refco_music' 
WHEN 
CONCAT(vd.CODE_REFERENCE,vd.CODE_COLORIS) IN
('100530619800','100528510021','100556916342','100558416034','100558318129','100557319600','100558219800','100533319800','100527716616','100561310141',
'100527610141','100543410141','100558118129','100557418129','100557410141','100563219600','100558519800','100558516653','100530710141','100561516034') 
THEN '04-refco_smiley'
ELSE '09- Autres_REFCO' END as list_refco,
CASE WHEN vd.type_emplacement IN ('EC','MP') THEN 1 ELSE K_Haring END AS tpmag_K_Haring ,
CASE WHEN vd.type_emplacement IN ('EC','MP') THEN 1 ELSE Musique END AS tpmag_music,
CASE WHEN vd.type_emplacement IN ('EC','MP') THEN 1 ELSE P_Kodak END AS tpmag_pkodak, 
CASE WHEN vd.type_emplacement IN ('EC','MP') THEN 1 ELSE smiley END AS tpmag_smiley,
Max(refco_KHARING) over (partition by code_client) AS Top_KHARING 
,Max(refco_PolaKodak) over (partition by code_client) AS Top_PolaKodak 
,Max(refco_music) over (partition by code_client) AS Top_music 
,Max(refco_smiley) over (partition by code_client) AS Top_smiley
FROM DATA_MESH_PROD_RETAIL.SHARED.T_VENTE_DENORMALISEE vd
LEFT join Magasin mag  on vd.ID_ORG_ENSEIGNE = mag.ID_ORG_ENSEIGNE and vd.ID_MAGASIN = mag.ID_MAGASIN
LEFT JOIN DATA_MESH_PROD_RETAIL.WORK.LISTE_MAGASINS_CAPSULES cap ON vd.ID_MAGASIN = cap.Num_Mag
where vd.date_ticket BETWEEN DATE($dtdeb) AND DATE($dtfin) 
  and (vd.ID_ORG_ENSEIGNE = $ENSEIGNE1 or vd.ID_ORG_ENSEIGNE = $ENSEIGNE2)
  and (mag.code_pays = $PAYS1 or mag.code_pays = $PAYS2))  
SELECT a.*, b.* 
,datediff(MONTH ,date_recrutement,$dtfin) AS ANCIENNETE_CLIENT
,CASE WHEN Date(date_recrutement) BETWEEN DATE($dtdeb) AND DATE($dtfin) THEN '02-Nouveaux' ELSE '01-Anciens' END AS Type_client
--,ROUND(DATEDIFF(YEAR,date_naissance,$dtfin),2) AS AGE_C
--, CASE WHEN (FLOOR((AGE_C) / 5) * 5) BETWEEN 15 AND 99 THEN CONCAT(FLOOR((AGE_C) / 5) * 5, '-', FLOOR((AGE_C) / 5) * 5 + 4) ELSE '99-NR/NC' END AS CLASSE_AGE
, CASE WHEN (FLOOR((AGE) / 5) * 5) BETWEEN 15 AND 95 THEN CONCAT(FLOOR((AGE) / 5) * 5, '-', FLOOR((AGE) / 5) * 5 + 4) ELSE '99-NR/NC' END AS CLASSE_AGE
	 , CASE WHEN pays_clt='FRA' AND SUBSTRING(code_postal, 1, 2) in ('75','77','78','91','92','93','94','95')             then  '01FRA_01_Ile de France' 
		      WHEN pays_clt='FRA' AND SUBSTRING(code_postal, 1, 2) in ('02', '59', '60', '62', '80')                                      then  '01FRA_02_Hauts-de-France'
              WHEN pays_clt='FRA' AND SUBSTRING(code_postal, 1, 2) in ('18', '28', '36', '37', '41', '45' )       						then  '01FRA_03_Centre-Val de Loire'
			  WHEN pays_clt='FRA' AND SUBSTRING(code_postal, 1, 2) in ('14', '27', '50', '61', '76')                                      then  '01FRA_04_Normandie'
			  WHEN pays_clt='FRA' AND SUBSTRING(code_postal, 1, 2) in ('44', '49', '53', '72', '85')                                      then  '01FRA_05_Pays de la Loire'
			  WHEN pays_clt='FRA' AND SUBSTRING(code_postal, 1, 2) in ('22','29','35','56')       						then  '01FRA_06_Bretagne'
			  WHEN pays_clt='FRA' AND SUBSTRING(code_postal, 1, 2) in ('16', '17', '19', '23', '24', '33', '40', '47', '64', '79', '86', '87')                                      then  '01FRA_07_Nouvelle-Aquitaine'	
			  WHEN pays_clt='FRA' AND SUBSTRING(code_postal, 1, 2) in ('08', '10', '51', '52', '54', '55', '57', '67', '68', '88')					then  '01FRA_08_Grand Est'
		      WHEN pays_clt='FRA' AND SUBSTRING(code_postal, 1, 2) in ('01','03','07','15','26','38','42','43','63','69','73','74' ) then  '01FRA_09_Auvergne-Rh ne-Alpes' 
			  WHEN pays_clt='FRA' AND SUBSTRING(code_postal, 1, 2) in ('21', '25', '39','58','70','71', '89', '90' ) then  '01FRA_10_Bourgogne-Franche-Comt ' 
		      WHEN pays_clt='FRA' AND SUBSTRING(code_postal, 1, 2) in ('09', '11', '12', '30', '31', '32', '34', '46', '48', '65', '66', '81', '82' )                                      then  '01FRA_11_Occitanie' 
		      WHEN pays_clt='FRA' AND SUBSTRING(code_postal, 1, 2) in ('04', '05', '06', '13', '83', '84')                                      then  '01FRA_12_Provence-Alpes-C te d Azur' 
			  WHEN pays_clt='FRA' AND SUBSTRING(code_postal, 1, 2) in ('20')											then  '01FRA_13_Corse' 
			  WHEN pays_clt='FRA' AND SUBSTRING(code_postal, 1, 3) in ('971','972','973','974','975','976','986','987','988') then  '01FRA_14_Outre-mer' 
			WHEN pays_clt='FRA' AND code_postal = '98000' 	then  '01FRA_15_Monaco'
			WHEN pays_clt='BEL'  	then  '02BELGIQUE'
			ELSE '01FRA_99_AUTRES/NC' END AS REGION -- a completer avec les informations de la BEL     
,CASE WHEN id_macro_segment = '01' THEN '01_VIP' 
     WHEN id_macro_segment = '02' THEN '02_TBC'
     WHEN id_macro_segment = '03' THEN '03_BC'
     WHEN id_macro_segment = '04' THEN '04_MOY'
     WHEN id_macro_segment = '05' THEN '05_TAP'
     WHEN id_macro_segment = '06' THEN '06_TIEDE'
     WHEN id_macro_segment = '07' THEN '07_TPURG'
     WHEN id_macro_segment = '09' THEN '08_NCV'
     WHEN id_macro_segment = '08' THEN '09_NAC'
     WHEN id_macro_segment = '10' THEN '10_INA12'
     WHEN id_macro_segment = '11' THEN '11_INA24'
  ELSE '12_NOSEG' END AS SEGMENT_RFM     
,CASE WHEN id_macro_segment IN ('01', '02', '03') THEN '01_Haut_de_Fichier' 
     WHEN id_macro_segment IN ('04', '09') THEN '02_Ventre_Mou' 
     WHEN id_macro_segment IN ('05', '06', '07','08') THEN '03_Bas_de_Fichier' 
     WHEN id_macro_segment IN ('10', '11') THEN '04_Inactifs' 
     ELSE '09_Non_Segmentes' END AS CAT_SEGMENT_RFM
,CASE WHEN (anciennete_client IS NULL) OR (anciennete_client BETWEEN 0 AND 12) THEN 'a: [0-12] mois' 
     WHEN anciennete_client IS NOT NULL AND anciennete_client BETWEEN 13 AND 24 THEN 'b: ]12-24] mois' 
     WHEN anciennete_client IS NOT NULL AND anciennete_client BETWEEN 25 AND 36 THEN 'c: ]24-36] mois'
     WHEN anciennete_client IS NOT NULL AND anciennete_client BETWEEN 37 AND 48 THEN 'd: ]36-48] mois'
     WHEN anciennete_client IS NOT NULL AND anciennete_client BETWEEN 49 AND 60 THEN 'e: ]48-60] mois'
     WHEN anciennete_client IS NOT NULL AND anciennete_client > 60 THEN 'f: + de 60 mois'
     else 'z: Non def' END  AS Tr_anciennete      
FROM tickets a
JOIN info_clt b ON a.CODE_CLIENT=b.idclient ;



SELECT * 
-- integration des données valiuz
-- Vus niveau VLZ 
-- Hierarchisation des données Clients , VLZ, MRKET,JULES

CREATE OR REPLACE TEMPORARY TABLE DATA_MESH_PROD_CLIENT.WORK.BASE_INFOCLT_VALIUZ AS
WITH DD_VLZ AS (SELECT DISTINCT 
CODE_CLIENT, CROSSCANAL_12_24_MARKET,CROSSCANAL_12_MARKET,CROSSCANAL_24_36_MARKET,CROSSCANAL_24_MARKET,CROSSCANAL_36_MARKET,PRICE_SENSITIVITY_MARKET,PROMO_SENSITIVITY_MARKET, 
AGE,ANIMAL_OWNER,CARREAU,CAT_OWNER,CROSSCANAL_12,CROSSCANAL_12_24,CROSSCANAL_24,CROSSCANAL_24_36,CROSSCANAL_36,CSR_ENVIRONMENT,CSR_HEALTHY,CSR_ORGANIC,DEDUP,DOG_OWNER,FAMILY_MATURITY, 
FAMILY_TOP_AGE,FAMILY_TOP_CHILD,FAMILY_TOP_COUPLE,FAMILY_TOP_INFANT,FAMILY_TOP_MAX_CHILD,FAMILY_TOP_NEWBORN,FAMILY_TOP_PRIMARY_SCHOOL,FAMILY_TOP_TEENAGER,GENDER,HOME_DELIVERY,HOUSEHOLD_TOP_AGE, 
HOUSEHOLD_TOP_AGE_TYPE,HOUSEHOLD_TOP_CHILD,HOUSEHOLD_TOP_COUPLE,HOUSEHOLD_TOP_INFANT,HOUSEHOLD_TOP_KIDS,HOUSEHOLD_TOP_MATURITY,HOUSEHOLD_TOP_MATURITY_TYPE,HOUSEHOLD_TOP_MAX_CHILD,HOUSEHOLD_TOP_NEWBORN, 
HOUSEHOLD_TOP_PRIMARYSCHOOL, HOUSEHOLD_TOP_TEENAGER,HOUSING_SCORE,IRIS,IS_B2B,LIFESTYLE_SEGMENT,MAG_FAVORITEDAY1,MAG_FAVORITEDAY2,MAG_FAVORITEDAY3,MAG_FAVORITEHOUR1,MAG_FAVORITEHOUR2,MAG_FAVORITEHOUR3, 
OPTIN_MAIL_VLZ, OPTIN_PRINT_VLZ,OPTIN_PUSH_APP_VLZ,OPTIN_SMS_VLZ,OPTIN_TEL_VLZ,OTHER_ANIMAL_OWNER,PRICE_SENSITIVITY,PROMO_SENSITIVITY,RECTANGLE,RELOCATION,RIP_SCORE,SECOND_HAND,SIRET_ENRICHED, 
SQUARE_SID,STORE_ACTIVITY,TOP_GARDEN,TOP_KIDS,TOP_OWNER,ZONE_ACTIVITY_MAG,ZONE_ACTIVITY_STATUS 
FROM DATA_MESH_PROD_client.SHARED.T_OBT_SCORE_VALIUZ WHERE id_niveau=2), 
DD_JULES AS (SELECT DISTINCT 
CODE_CLIENT, CROSSCANAL_12_24_MARKET,CROSSCANAL_12_MARKET,CROSSCANAL_24_36_MARKET,CROSSCANAL_24_MARKET,CROSSCANAL_36_MARKET,PRICE_SENSITIVITY_MARKET,PROMO_SENSITIVITY_MARKET, 
AGE,ANIMAL_OWNER,CARREAU,CAT_OWNER,CROSSCANAL_12,CROSSCANAL_12_24,CROSSCANAL_24,CROSSCANAL_24_36,CROSSCANAL_36,CSR_ENVIRONMENT,CSR_HEALTHY,CSR_ORGANIC,DEDUP,DOG_OWNER,FAMILY_MATURITY, 
FAMILY_TOP_AGE,FAMILY_TOP_CHILD,FAMILY_TOP_COUPLE,FAMILY_TOP_INFANT,FAMILY_TOP_MAX_CHILD,FAMILY_TOP_NEWBORN,FAMILY_TOP_PRIMARY_SCHOOL,FAMILY_TOP_TEENAGER,GENDER,HOME_DELIVERY,HOUSEHOLD_TOP_AGE, 
HOUSEHOLD_TOP_AGE_TYPE,HOUSEHOLD_TOP_CHILD,HOUSEHOLD_TOP_COUPLE,HOUSEHOLD_TOP_INFANT,HOUSEHOLD_TOP_KIDS,HOUSEHOLD_TOP_MATURITY,HOUSEHOLD_TOP_MATURITY_TYPE,HOUSEHOLD_TOP_MAX_CHILD,HOUSEHOLD_TOP_NEWBORN, 
HOUSEHOLD_TOP_PRIMARYSCHOOL, HOUSEHOLD_TOP_TEENAGER,HOUSING_SCORE,IRIS,IS_B2B,LIFESTYLE_SEGMENT,MAG_FAVORITEDAY1,MAG_FAVORITEDAY2,MAG_FAVORITEDAY3,MAG_FAVORITEHOUR1,MAG_FAVORITEHOUR2,MAG_FAVORITEHOUR3, 
OPTIN_MAIL_VLZ, OPTIN_PRINT_VLZ,OPTIN_PUSH_APP_VLZ,OPTIN_SMS_VLZ,OPTIN_TEL_VLZ,OTHER_ANIMAL_OWNER,PRICE_SENSITIVITY,PROMO_SENSITIVITY,RECTANGLE,RELOCATION,RIP_SCORE,SECOND_HAND,SIRET_ENRICHED, 
SQUARE_SID,STORE_ACTIVITY,TOP_GARDEN,TOP_KIDS,TOP_OWNER,ZONE_ACTIVITY_MAG,ZONE_ACTIVITY_STATUS 
FROM DATA_MESH_PROD_client.SHARED.T_OBT_SCORE_VALIUZ WHERE id_niveau=1), 
DD_MKT AS (SELECT DISTINCT 
CODE_CLIENT, CROSSCANAL_12_24_MARKET,CROSSCANAL_12_MARKET,CROSSCANAL_24_36_MARKET,CROSSCANAL_24_MARKET,CROSSCANAL_36_MARKET,PRICE_SENSITIVITY_MARKET,PROMO_SENSITIVITY_MARKET, 
AGE,ANIMAL_OWNER,CARREAU,CAT_OWNER,CROSSCANAL_12,CROSSCANAL_12_24,CROSSCANAL_24,CROSSCANAL_24_36,CROSSCANAL_36,CSR_ENVIRONMENT,CSR_HEALTHY,CSR_ORGANIC,DEDUP,DOG_OWNER,FAMILY_MATURITY, 
FAMILY_TOP_AGE,FAMILY_TOP_CHILD,FAMILY_TOP_COUPLE,FAMILY_TOP_INFANT,FAMILY_TOP_MAX_CHILD,FAMILY_TOP_NEWBORN,FAMILY_TOP_PRIMARY_SCHOOL,FAMILY_TOP_TEENAGER,GENDER,HOME_DELIVERY,HOUSEHOLD_TOP_AGE, 
HOUSEHOLD_TOP_AGE_TYPE,HOUSEHOLD_TOP_CHILD,HOUSEHOLD_TOP_COUPLE,HOUSEHOLD_TOP_INFANT,HOUSEHOLD_TOP_KIDS,HOUSEHOLD_TOP_MATURITY,HOUSEHOLD_TOP_MATURITY_TYPE,HOUSEHOLD_TOP_MAX_CHILD,HOUSEHOLD_TOP_NEWBORN, 
HOUSEHOLD_TOP_PRIMARYSCHOOL, HOUSEHOLD_TOP_TEENAGER,HOUSING_SCORE,IRIS,IS_B2B,LIFESTYLE_SEGMENT,MAG_FAVORITEDAY1,MAG_FAVORITEDAY2,MAG_FAVORITEDAY3,MAG_FAVORITEHOUR1,MAG_FAVORITEHOUR2,MAG_FAVORITEHOUR3, 
OPTIN_MAIL_VLZ, OPTIN_PRINT_VLZ,OPTIN_PUSH_APP_VLZ,OPTIN_SMS_VLZ,OPTIN_TEL_VLZ,OTHER_ANIMAL_OWNER,PRICE_SENSITIVITY,PROMO_SENSITIVITY,RECTANGLE,RELOCATION,RIP_SCORE,SECOND_HAND,SIRET_ENRICHED, 
SQUARE_SID,STORE_ACTIVITY,TOP_GARDEN,TOP_KIDS,TOP_OWNER,ZONE_ACTIVITY_MAG,ZONE_ACTIVITY_STATUS 
FROM DATA_MESH_PROD_client.SHARED.T_OBT_SCORE_VALIUZ WHERE id_niveau=3),
Synth_vlz AS (SELECT DISTINCT 
COALESCE(a.CODE_CLIENT, b.CODE_CLIENT, c.CODE_CLIENT) as  ID_CLIENT, 
COALESCE(a.CROSSCANAL_12_24_MARKET, b.CROSSCANAL_12_24_MARKET, c.CROSSCANAL_12_24_MARKET) as CROSSCANAL_12_24_MARKET, 
COALESCE(a.CROSSCANAL_12_MARKET, b.CROSSCANAL_12_MARKET, c.CROSSCANAL_12_MARKET) as CROSSCANAL_12_MARKET, 
COALESCE(a.CROSSCANAL_24_36_MARKET, b.CROSSCANAL_24_36_MARKET, c.CROSSCANAL_24_36_MARKET) as CROSSCANAL_24_36_MARKET, 
COALESCE(a.CROSSCANAL_24_MARKET, b.CROSSCANAL_24_MARKET, c.CROSSCANAL_24_MARKET) as CROSSCANAL_24_MARKET, 
COALESCE(a.CROSSCANAL_36_MARKET, b.CROSSCANAL_36_MARKET, c.CROSSCANAL_36_MARKET) as CROSSCANAL_36_MARKET, 
COALESCE(a.PRICE_SENSITIVITY_MARKET, b.PRICE_SENSITIVITY_MARKET, c.PRICE_SENSITIVITY_MARKET) as PRICE_SENSITIVITY_MARKET, 
COALESCE(a.PROMO_SENSITIVITY_MARKET, b.PROMO_SENSITIVITY_MARKET, c.PROMO_SENSITIVITY_MARKET) as PROMO_SENSITIVITY_MARKET, 
COALESCE(a.AGE, b.AGE, c.AGE) as AGE_VLZ, 
COALESCE(a.ANIMAL_OWNER, b.ANIMAL_OWNER, c.ANIMAL_OWNER) as ANIMAL_OWNER, 
COALESCE(a.CARREAU, b.CARREAU, c.CARREAU) as CARREAU, 
COALESCE(a.CAT_OWNER, b.CAT_OWNER, c.CAT_OWNER) as CAT_OWNER, 
COALESCE(a.CROSSCANAL_12, b.CROSSCANAL_12, c.CROSSCANAL_12) as CROSSCANAL_12, 
COALESCE(a.CROSSCANAL_12_24, b.CROSSCANAL_12_24, c.CROSSCANAL_12_24) as CROSSCANAL_12_24, 
COALESCE(a.CROSSCANAL_24, b.CROSSCANAL_24, c.CROSSCANAL_24) as CROSSCANAL_24, 
COALESCE(a.CROSSCANAL_24_36, b.CROSSCANAL_24_36, c.CROSSCANAL_24_36) as CROSSCANAL_24_36, 
COALESCE(a.CROSSCANAL_36, b.CROSSCANAL_36, c.CROSSCANAL_36) as CROSSCANAL_36, 
COALESCE(a.CSR_ENVIRONMENT, b.CSR_ENVIRONMENT, c.CSR_ENVIRONMENT) as CSR_ENVIRONMENT, 
COALESCE(a.CSR_HEALTHY, b.CSR_HEALTHY, c.CSR_HEALTHY) as CSR_HEALTHY, 
COALESCE(a.CSR_ORGANIC, b.CSR_ORGANIC, c.CSR_ORGANIC) as CSR_ORGANIC, 
COALESCE(a.DEDUP, b.DEDUP, c.DEDUP) as DEDUP, 
COALESCE(a.DOG_OWNER, b.DOG_OWNER, c.DOG_OWNER) as DOG_OWNER, 
COALESCE(a.FAMILY_MATURITY, b.FAMILY_MATURITY, c.FAMILY_MATURITY) as FAMILY_MATURITY, 
COALESCE(a.FAMILY_TOP_AGE, b.FAMILY_TOP_AGE, c.FAMILY_TOP_AGE) as FAMILY_TOP_AGE, 
COALESCE(a.FAMILY_TOP_CHILD, b.FAMILY_TOP_CHILD, c.FAMILY_TOP_CHILD) as FAMILY_TOP_CHILD, 
COALESCE(a.FAMILY_TOP_COUPLE, b.FAMILY_TOP_COUPLE, c.FAMILY_TOP_COUPLE) as FAMILY_TOP_COUPLE, 
COALESCE(a.FAMILY_TOP_INFANT, b.FAMILY_TOP_INFANT, c.FAMILY_TOP_INFANT) as FAMILY_TOP_INFANT, 
COALESCE(a.FAMILY_TOP_MAX_CHILD, b.FAMILY_TOP_MAX_CHILD, c.FAMILY_TOP_MAX_CHILD) as FAMILY_TOP_MAX_CHILD, 
COALESCE(a.FAMILY_TOP_NEWBORN, b.FAMILY_TOP_NEWBORN, c.FAMILY_TOP_NEWBORN) as FAMILY_TOP_NEWBORN, 
COALESCE(a.FAMILY_TOP_PRIMARY_SCHOOL, b.FAMILY_TOP_PRIMARY_SCHOOL, c.FAMILY_TOP_PRIMARY_SCHOOL) as FAMILY_TOP_PRIMARY_SCHOOL, 
COALESCE(a.FAMILY_TOP_TEENAGER, b.FAMILY_TOP_TEENAGER, c.FAMILY_TOP_TEENAGER) as FAMILY_TOP_TEENAGER, 
COALESCE(a.GENDER, b.GENDER, c.GENDER) as GENDER_VLZ, 
COALESCE(a.HOME_DELIVERY, b.HOME_DELIVERY, c.HOME_DELIVERY) as HOME_DELIVERY, 
COALESCE(a.HOUSEHOLD_TOP_AGE, b.HOUSEHOLD_TOP_AGE, c.HOUSEHOLD_TOP_AGE) as HOUSEHOLD_TOP_AGE, 
COALESCE(a.HOUSEHOLD_TOP_AGE_TYPE, b.HOUSEHOLD_TOP_AGE_TYPE, c.HOUSEHOLD_TOP_AGE_TYPE) as HOUSEHOLD_TOP_AGE_TYPE, 
COALESCE(a.HOUSEHOLD_TOP_CHILD, b.HOUSEHOLD_TOP_CHILD, c.HOUSEHOLD_TOP_CHILD) as HOUSEHOLD_TOP_CHILD, 
COALESCE(a.HOUSEHOLD_TOP_COUPLE, b.HOUSEHOLD_TOP_COUPLE, c.HOUSEHOLD_TOP_COUPLE) as HOUSEHOLD_TOP_COUPLE, 
COALESCE(a.HOUSEHOLD_TOP_INFANT, b.HOUSEHOLD_TOP_INFANT, c.HOUSEHOLD_TOP_INFANT) as HOUSEHOLD_TOP_INFANT, 
COALESCE(a.HOUSEHOLD_TOP_KIDS, b.HOUSEHOLD_TOP_KIDS, c.HOUSEHOLD_TOP_KIDS) as HOUSEHOLD_TOP_KIDS, 
COALESCE(a.HOUSEHOLD_TOP_MATURITY, b.HOUSEHOLD_TOP_MATURITY, c.HOUSEHOLD_TOP_MATURITY) as HOUSEHOLD_TOP_MATURITY, 
COALESCE(a.HOUSEHOLD_TOP_MATURITY_TYPE, b.HOUSEHOLD_TOP_MATURITY_TYPE, c.HOUSEHOLD_TOP_MATURITY_TYPE) as HOUSEHOLD_TOP_MATURITY_TYPE, 
COALESCE(a.HOUSEHOLD_TOP_MAX_CHILD, b.HOUSEHOLD_TOP_MAX_CHILD, c.HOUSEHOLD_TOP_MAX_CHILD) as HOUSEHOLD_TOP_MAX_CHILD, 
COALESCE(a.HOUSEHOLD_TOP_NEWBORN, b.HOUSEHOLD_TOP_NEWBORN, c.HOUSEHOLD_TOP_NEWBORN) as HOUSEHOLD_TOP_NEWBORN, 
COALESCE(a.HOUSEHOLD_TOP_PRIMARYSCHOOL, b.HOUSEHOLD_TOP_PRIMARYSCHOOL, c.HOUSEHOLD_TOP_PRIMARYSCHOOL) as HOUSEHOLD_TOP_PRIMARYSCHOOL, 
COALESCE(a.HOUSEHOLD_TOP_TEENAGER, b.HOUSEHOLD_TOP_TEENAGER, c.HOUSEHOLD_TOP_TEENAGER) as HOUSEHOLD_TOP_TEENAGER, 
COALESCE(a.HOUSING_SCORE, b.HOUSING_SCORE, c.HOUSING_SCORE) as HOUSING_SCORE, 
COALESCE(a.IRIS, b.IRIS, c.IRIS) as IRIS, 
COALESCE(a.IS_B2B, b.IS_B2B, c.IS_B2B) as IS_B2B, 
COALESCE(a.LIFESTYLE_SEGMENT, b.LIFESTYLE_SEGMENT, c.LIFESTYLE_SEGMENT) as LIFESTYLE_SEGMENT, 
COALESCE(a.MAG_FAVORITEDAY1, b.MAG_FAVORITEDAY1, c.MAG_FAVORITEDAY1) as MAG_FAVORITEDAY1, 
COALESCE(a.MAG_FAVORITEDAY2, b.MAG_FAVORITEDAY2, c.MAG_FAVORITEDAY2) as MAG_FAVORITEDAY2, 
COALESCE(a.MAG_FAVORITEDAY3, b.MAG_FAVORITEDAY3, c.MAG_FAVORITEDAY3) as MAG_FAVORITEDAY3, 
COALESCE(a.MAG_FAVORITEHOUR1, b.MAG_FAVORITEHOUR1, c.MAG_FAVORITEHOUR1) as MAG_FAVORITEHOUR1, 
COALESCE(a.MAG_FAVORITEHOUR2, b.MAG_FAVORITEHOUR2, c.MAG_FAVORITEHOUR2) as MAG_FAVORITEHOUR2, 
COALESCE(a.MAG_FAVORITEHOUR3, b.MAG_FAVORITEHOUR3, c.MAG_FAVORITEHOUR3) as MAG_FAVORITEHOUR3, 
COALESCE(a.OPTIN_MAIL_VLZ, b.OPTIN_MAIL_VLZ, c.OPTIN_MAIL_VLZ) as OPTIN_MAIL_VLZ, 
COALESCE(a.OPTIN_PRINT_VLZ, b.OPTIN_PRINT_VLZ, c.OPTIN_PRINT_VLZ) as OPTIN_PRINT_VLZ, 
COALESCE(a.OPTIN_PUSH_APP_VLZ, b.OPTIN_PUSH_APP_VLZ, c.OPTIN_PUSH_APP_VLZ) as OPTIN_PUSH_APP_VLZ, 
COALESCE(a.OPTIN_SMS_VLZ, b.OPTIN_SMS_VLZ, c.OPTIN_SMS_VLZ) as OPTIN_SMS_VLZ, 
COALESCE(a.OPTIN_TEL_VLZ, b.OPTIN_TEL_VLZ, c.OPTIN_TEL_VLZ) as OPTIN_TEL_VLZ, 
COALESCE(a.OTHER_ANIMAL_OWNER, b.OTHER_ANIMAL_OWNER, c.OTHER_ANIMAL_OWNER) as OTHER_ANIMAL_OWNER, 
COALESCE(a.PRICE_SENSITIVITY, b.PRICE_SENSITIVITY, c.PRICE_SENSITIVITY) as PRICE_SENSITIVITY, 
COALESCE(a.PROMO_SENSITIVITY, b.PROMO_SENSITIVITY, c.PROMO_SENSITIVITY) as PROMO_SENSITIVITY, 
COALESCE(a.RECTANGLE, b.RECTANGLE, c.RECTANGLE) as RECTANGLE, 
COALESCE(a.RELOCATION, b.RELOCATION, c.RELOCATION) as RELOCATION, 
COALESCE(a.RIP_SCORE, b.RIP_SCORE, c.RIP_SCORE) as RIP_SCORE, 
COALESCE(a.SECOND_HAND, b.SECOND_HAND, c.SECOND_HAND) as SECOND_HAND, 
COALESCE(a.SIRET_ENRICHED, b.SIRET_ENRICHED, c.SIRET_ENRICHED) as SIRET_ENRICHED, 
COALESCE(a.SQUARE_SID, b.SQUARE_SID, c.SQUARE_SID) as SQUARE_SID, 
COALESCE(a.STORE_ACTIVITY, b.STORE_ACTIVITY, c.STORE_ACTIVITY) as STORE_ACTIVITY, 
COALESCE(a.TOP_GARDEN, b.TOP_GARDEN, c.TOP_GARDEN) as TOP_GARDEN, 
COALESCE(a.TOP_KIDS, b.TOP_KIDS, c.TOP_KIDS) as TOP_KIDS, 
COALESCE(a.TOP_OWNER, b.TOP_OWNER, c.TOP_OWNER) as TOP_OWNER, 
COALESCE(a.ZONE_ACTIVITY_MAG, b.ZONE_ACTIVITY_MAG, c.ZONE_ACTIVITY_MAG) as ZONE_ACTIVITY_MAG, 
COALESCE(a.ZONE_ACTIVITY_STATUS, b.ZONE_ACTIVITY_STATUS, c.ZONE_ACTIVITY_STATUS) as ZONE_ACTIVITY_STATUS
FROM DD_VLZ a 
FULL JOIN DD_JULES b ON a.CODE_CLIENT=b.CODE_CLIENT
FULL JOIN DD_MKT c ON a.CODE_CLIENT=c.CODE_CLIENT )
SELECT *
FROM Synth_vlz ; 

SELECT * FROM DATA_MESH_PROD_CLIENT.WORK.BASE_INFOCLT_VALIUZ LIMIT 10; 

CREATE OR REPLACE TEMPORARY TABLE DATA_MESH_PROD_CLIENT.WORK.BASE_INFOCLT_CAPSULES_V2 AS
SELECT a.*, AGE_VLZ, GENDER_VLZ,
case when SUBSTRING(SQUARE_SID, 1, 3) in ('157','158','159','160','161','162','163','164','165','166') THEN '01-PARISIENS'
     when SUBSTRING(SQUARE_SID, 1, 3) in ('167','168','169','170','171','172','173','174','175','176') THEN '02-URBAINS'
     when SUBSTRING(SQUARE_SID, 1, 3) in ('177','178','179','180') THEN '03-PERIURBAINS'
     when SUBSTRING(SQUARE_SID, 1, 3) in ('181','182','183') THEN '04-RURAUX'
     else '99-NON RENSEIGNE' END as SQUARE_SID_V2,
Case when STORE_ACTIVITY='STORE_ACTIVE' then '01-ACTIFS' 
     when STORE_ACTIVITY='STORE_LEAVER_NEARBY' then '02-ABANDONNISTES PROCHES' 
     when STORE_ACTIVITY='STORE_LEAVER' then '03-ABANDONNISTES' 
     when STORE_ACTIVITY='STORE_OUT_OF_SCOPE' then '04-ABANDONNISTES HORS SCOPE' 
     when STORE_ACTIVITY='STORE_INACTIVE' then '05-INACTIFS' 
     else '99-NON RENSEIGNE' END as STORE_ACTIVITY_V2,
Case when ZONE_ACTIVITY_STATUS='LOYAL' then '01-LOYAL' 
     when ZONE_ACTIVITY_STATUS='NEW_ON_ZONE' then '02-NOUVEAU SUR ZONE' 
     when ZONE_ACTIVITY_STATUS='LEAVER' then '03-ABANDONNISTES' 
     when ZONE_ACTIVITY_STATUS='OUT_OF_SCOPE' then '04- HORS ZONE' 
     when ZONE_ACTIVITY_STATUS='INACTIVE' then '05-INACTIFS' 
      else '99-NON RENSEIGNE' END as ZONE_ACTIVITY_STATUS_V2,
case when HOUSEHOLD_TOP_MATURITY='1' then '01-Jeune célibataire'
     when HOUSEHOLD_TOP_MATURITY='2' then '02-Jeune couple'
     when HOUSEHOLD_TOP_MATURITY='3' then '03-Famille avec bébés'
     when HOUSEHOLD_TOP_MATURITY='4' then '04-Famille avec jeunes enfants'
     when HOUSEHOLD_TOP_MATURITY='5' then '05-Famille avec adolescents'
     when HOUSEHOLD_TOP_MATURITY='6' then '06-Couple adulte'
     when HOUSEHOLD_TOP_MATURITY='7' then '07-Couple senior'
     when HOUSEHOLD_TOP_MATURITY='8' then '08-Grand-parent'
     when HOUSEHOLD_TOP_MATURITY='9' then '09-Senior célibataire'
     ELSE '99-NON RENSEIGNE' END AS FAMILY_MATURITY_V2,      
case when price_sensitivity is null then '99-NON RENSEIGNE'
else price_sensitivity end as price_V2, 
case when promo_sensitivity='INSENSIBLE' then '01-INSENSIBLE'
     when promo_sensitivity='PROMOPHOBE' then '02-PROMOPHOBE'
     when promo_sensitivity='PROMOSENSIBLE' then '03-PROMOSENSIBLE'
     when promo_sensitivity='OPPORTUNISTE' then '04-OPPORTUNISTE'
     when promo_sensitivity='PROMOPHILE' then '05-PROMOPHILE'
     ELSE '99-NON RENSEIGNE' END AS promo_V2, 
case when lifestyle_segment is null or lifestyle_segment IN ('',' ','-1','V') then 'Z-NON RENSEIGNE'
else lifestyle_segment end as lifestyle_segment_V2, 
case when CROSSCANAL_12 is null OR CROSSCANAL_12 IN ('',' ','-1','V') then 'Z-NON RENSEIGNE'
else CROSSCANAL_12 end as CROSSCANAL_12_V2, 
case when CROSSCANAL_12_24 is null OR CROSSCANAL_12_24 IN ('',' ','-1','V') then 'Z-NON RENSEIGNE'
else CROSSCANAL_12_24 end as CROSSCANAL_12_24_V2, 
case when CROSSCANAL_24 is null OR CROSSCANAL_24 IN ('',' ','-1','V') then 'Z-NON RENSEIGNE'
else CROSSCANAL_24 end as CROSSCANAL_24_V2, 
case when CROSSCANAL_24_36 is null OR CROSSCANAL_24_36 IN ('',' ','-1','V') then 'Z-NON RENSEIGNE'
else CROSSCANAL_24_36 end as CROSSCANAL_24_36_V2, 
case when CROSSCANAL_36 is null OR CROSSCANAL_36 IN ('',' ','-1','V') then 'Z-NON RENSEIGNE'
else CROSSCANAL_36 end as CROSSCANAL_36_V2,
case when CSR_ENVIRONMENT is null or CSR_ENVIRONMENT IN ('',' ','-1','V') then '99-NON RENSEIGNE'
else CSR_ENVIRONMENT end as CSR_ENVIRONMENT_V2, 
case when CSR_HEALTHY is null or CSR_HEALTHY IN ('',' ','-1','V') then '99-NON RENSEIGNE'
else CSR_HEALTHY end as CSR_HEALTHY_V2, 
case when CSR_ORGANIC is null or CSR_ORGANIC IN ('',' ','-1','V') then '99-NON RENSEIGNE'
else CSR_ORGANIC end as CSR_ORGANIC_V2
FROM DATA_MESH_PROD_CLIENT.WORK.BASE_INFOCLT_CAPSULES a 
LEFT JOIN DATA_MESH_PROD_CLIENT.WORK.BASE_INFOCLT_VALIUZ b ON a.CODE_CLIENT=b.ID_CLIENT ;

--SELECT * FROM DATA_MESH_PROD_CLIENT.WORK.BASE_INFOCLT_CAPSULES_V2 WHERE Top_KHARING =1 AND LIB_FAMILLE_ACHAT ='Bermuda'
--AND code_client = '044310008853'; 

--SELECT * FROM DATA_MESH_PROD_CLIENT.WORK.BASE_INFOCLT_CAPSULES_V2 WHERE code_client = '044310008853'; 

CREATE OR REPLACE TEMPORARY TABLE DATA_MESH_PROD_CLIENT.WORK.KPICLT_CAPSULES AS
SELECT * FROM (
-- simulation donnees pour KH 
SELECT '00_GLOBAL' AS typo_clt, '00_GLOBAL' AS modalite
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then date_ticket END) AS MINDTE_KH_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then date_ticket END) AS MAXDTE_KH_Glb
    ,COUNT(DISTINCT CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then CODE_CLIENT end) AS nb_clt_KH
    ,COUNT(DISTINCT CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then id_ticket END) AS nb_ticket_KH
    ,SUM(CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_TTC END) AS CA_KH
	,SUM(CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then QUANTITE_LIGNE END) AS qte_achete_KH
    ,SUM(CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_MARGE_SORTIE END) AS Marge_KH
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then CODE_CLIENT end) AS nb_clt_KH_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then id_ticket END) AS nb_ticket_KH_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_TTC END) AS CA_KH_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then QUANTITE_LIGNE END) AS qte_achete_KH_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_MARGE_SORTIE END) AS Marge_KH_Glb	
    ,COUNT(DISTINCT CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_KH           
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then date_ticket END) AS MINDTE_PK_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then date_ticket END) AS MAXDTE_PK_Glb
    ,COUNT(DISTINCT CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then CODE_CLIENT end) AS nb_clt_PK
    ,COUNT(DISTINCT CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then id_ticket END) AS nb_ticket_PK
    ,SUM(CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_TTC END) AS CA_PK
	,SUM(CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then QUANTITE_LIGNE END) AS qte_achete_PK
    ,SUM(CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_MARGE_SORTIE END) AS Marge_PK
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then CODE_CLIENT end) AS nb_clt_PK_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then id_ticket END) AS nb_ticket_PK_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_TTC END) AS CA_PK_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then QUANTITE_LIGNE END) AS qte_achete_PK_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_MARGE_SORTIE END) AS Marge_PK_Glb 
    ,COUNT(DISTINCT CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_PK    
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then date_ticket END) AS MINDTE_music_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then date_ticket END) AS MAXDTE_music_Glb
    ,COUNT(DISTINCT CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then CODE_CLIENT end) AS nb_clt_music
    ,COUNT(DISTINCT CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then id_ticket END) AS nb_ticket_music
    ,SUM(CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_TTC END) AS CA_music
	,SUM(CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then QUANTITE_LIGNE END) AS qte_achete_music
    ,SUM(CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_MARGE_SORTIE END) AS Marge_music
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then CODE_CLIENT end) AS nb_clt_music_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then id_ticket END) AS nb_ticket_music_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_TTC END) AS CA_music_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then QUANTITE_LIGNE END) AS qte_achete_music_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_MARGE_SORTIE END) AS Marge_music_Glb
    ,COUNT(DISTINCT CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_music        
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then date_ticket END) AS MINDTE_smiley_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then date_ticket END) AS MAXDTE_smiley_Glb
    ,COUNT(DISTINCT CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then CODE_CLIENT end) AS nb_clt_smiley
    ,COUNT(DISTINCT CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then id_ticket END) AS nb_ticket_smiley
    ,SUM(CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_TTC END) AS CA_smiley
	,SUM(CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then QUANTITE_LIGNE END) AS qte_achete_smiley
    ,SUM(CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_MARGE_SORTIE END) AS Marge_smiley
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then CODE_CLIENT end) AS nb_clt_smiley_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then id_ticket END) AS nb_ticket_smiley_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_TTC END) AS CA_smiley_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then QUANTITE_LIGNE END) AS qte_achete_smiley_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_MARGE_SORTIE END) AS Marge_smiley_Glb
    ,COUNT(DISTINCT CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_smiley
FROM DATA_MESH_PROD_CLIENT.WORK.BASE_INFOCLT_CAPSULES_V2
GROUP BY 1,2
UNION
SELECT '01_GENRE' AS typo_clt, CASE 	
 WHEN GENDER='H' THEN '01-Hommes'
 WHEN GENDER='F' THEN '02-Femmes'
 ELSE '03-Autres/NC'  END AS modalite
  	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then date_ticket END) AS MINDTE_KH_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then date_ticket END) AS MAXDTE_KH_Glb
    ,COUNT(DISTINCT CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then CODE_CLIENT end) AS nb_clt_KH
    ,COUNT(DISTINCT CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then id_ticket END) AS nb_ticket_KH
    ,SUM(CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_TTC END) AS CA_KH
	,SUM(CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then QUANTITE_LIGNE END) AS qte_achete_KH
    ,SUM(CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_MARGE_SORTIE END) AS Marge_KH
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then CODE_CLIENT end) AS nb_clt_KH_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then id_ticket END) AS nb_ticket_KH_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_TTC END) AS CA_KH_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then QUANTITE_LIGNE END) AS qte_achete_KH_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_MARGE_SORTIE END) AS Marge_KH_Glb	
    ,COUNT(DISTINCT CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_KH           
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then date_ticket END) AS MINDTE_PK_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then date_ticket END) AS MAXDTE_PK_Glb
    ,COUNT(DISTINCT CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then CODE_CLIENT end) AS nb_clt_PK
    ,COUNT(DISTINCT CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then id_ticket END) AS nb_ticket_PK
    ,SUM(CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_TTC END) AS CA_PK
	,SUM(CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then QUANTITE_LIGNE END) AS qte_achete_PK
    ,SUM(CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_MARGE_SORTIE END) AS Marge_PK
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then CODE_CLIENT end) AS nb_clt_PK_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then id_ticket END) AS nb_ticket_PK_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_TTC END) AS CA_PK_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then QUANTITE_LIGNE END) AS qte_achete_PK_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_MARGE_SORTIE END) AS Marge_PK_Glb 
    ,COUNT(DISTINCT CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_PK    
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then date_ticket END) AS MINDTE_music_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then date_ticket END) AS MAXDTE_music_Glb
    ,COUNT(DISTINCT CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then CODE_CLIENT end) AS nb_clt_music
    ,COUNT(DISTINCT CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then id_ticket END) AS nb_ticket_music
    ,SUM(CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_TTC END) AS CA_music
	,SUM(CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then QUANTITE_LIGNE END) AS qte_achete_music
    ,SUM(CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_MARGE_SORTIE END) AS Marge_music
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then CODE_CLIENT end) AS nb_clt_music_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then id_ticket END) AS nb_ticket_music_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_TTC END) AS CA_music_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then QUANTITE_LIGNE END) AS qte_achete_music_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_MARGE_SORTIE END) AS Marge_music_Glb
    ,COUNT(DISTINCT CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_music        
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then date_ticket END) AS MINDTE_smiley_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then date_ticket END) AS MAXDTE_smiley_Glb
    ,COUNT(DISTINCT CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then CODE_CLIENT end) AS nb_clt_smiley
    ,COUNT(DISTINCT CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then id_ticket END) AS nb_ticket_smiley
    ,SUM(CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_TTC END) AS CA_smiley
	,SUM(CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then QUANTITE_LIGNE END) AS qte_achete_smiley
    ,SUM(CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_MARGE_SORTIE END) AS Marge_smiley
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then CODE_CLIENT end) AS nb_clt_smiley_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then id_ticket END) AS nb_ticket_smiley_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_TTC END) AS CA_smiley_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then QUANTITE_LIGNE END) AS qte_achete_smiley_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_MARGE_SORTIE END) AS Marge_smiley_Glb
    ,COUNT(DISTINCT CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_smiley
FROM DATA_MESH_PROD_CLIENT.WORK.BASE_INFOCLT_CAPSULES_V2
GROUP BY 1,2
UNION
SELECT '02_TYPE_CLIENT' AS typo_clt, TYPE_CLIENT AS modalite 
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then date_ticket END) AS MINDTE_KH_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then date_ticket END) AS MAXDTE_KH_Glb
    ,COUNT(DISTINCT CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then CODE_CLIENT end) AS nb_clt_KH
    ,COUNT(DISTINCT CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then id_ticket END) AS nb_ticket_KH
    ,SUM(CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_TTC END) AS CA_KH
	,SUM(CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then QUANTITE_LIGNE END) AS qte_achete_KH
    ,SUM(CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_MARGE_SORTIE END) AS Marge_KH
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then CODE_CLIENT end) AS nb_clt_KH_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then id_ticket END) AS nb_ticket_KH_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_TTC END) AS CA_KH_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then QUANTITE_LIGNE END) AS qte_achete_KH_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_MARGE_SORTIE END) AS Marge_KH_Glb	
    ,COUNT(DISTINCT CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_KH           
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then date_ticket END) AS MINDTE_PK_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then date_ticket END) AS MAXDTE_PK_Glb
    ,COUNT(DISTINCT CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then CODE_CLIENT end) AS nb_clt_PK
    ,COUNT(DISTINCT CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then id_ticket END) AS nb_ticket_PK
    ,SUM(CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_TTC END) AS CA_PK
	,SUM(CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then QUANTITE_LIGNE END) AS qte_achete_PK
    ,SUM(CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_MARGE_SORTIE END) AS Marge_PK
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then CODE_CLIENT end) AS nb_clt_PK_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then id_ticket END) AS nb_ticket_PK_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_TTC END) AS CA_PK_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then QUANTITE_LIGNE END) AS qte_achete_PK_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_MARGE_SORTIE END) AS Marge_PK_Glb 
    ,COUNT(DISTINCT CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_PK    
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then date_ticket END) AS MINDTE_music_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then date_ticket END) AS MAXDTE_music_Glb
    ,COUNT(DISTINCT CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then CODE_CLIENT end) AS nb_clt_music
    ,COUNT(DISTINCT CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then id_ticket END) AS nb_ticket_music
    ,SUM(CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_TTC END) AS CA_music
	,SUM(CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then QUANTITE_LIGNE END) AS qte_achete_music
    ,SUM(CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_MARGE_SORTIE END) AS Marge_music
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then CODE_CLIENT end) AS nb_clt_music_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then id_ticket END) AS nb_ticket_music_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_TTC END) AS CA_music_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then QUANTITE_LIGNE END) AS qte_achete_music_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_MARGE_SORTIE END) AS Marge_music_Glb
    ,COUNT(DISTINCT CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_music        
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then date_ticket END) AS MINDTE_smiley_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then date_ticket END) AS MAXDTE_smiley_Glb
    ,COUNT(DISTINCT CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then CODE_CLIENT end) AS nb_clt_smiley
    ,COUNT(DISTINCT CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then id_ticket END) AS nb_ticket_smiley
    ,SUM(CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_TTC END) AS CA_smiley
	,SUM(CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then QUANTITE_LIGNE END) AS qte_achete_smiley
    ,SUM(CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_MARGE_SORTIE END) AS Marge_smiley
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then CODE_CLIENT end) AS nb_clt_smiley_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then id_ticket END) AS nb_ticket_smiley_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_TTC END) AS CA_smiley_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then QUANTITE_LIGNE END) AS qte_achete_smiley_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_MARGE_SORTIE END) AS Marge_smiley_Glb
    ,COUNT(DISTINCT CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_smiley
FROM DATA_MESH_PROD_CLIENT.WORK.BASE_INFOCLT_CAPSULES_V2
GROUP BY 1,2
UNION
SELECT '03_CAT_SEGMENT_RFM' AS typo_clt,  CAT_SEGMENT_RFM AS modalite
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then date_ticket END) AS MINDTE_KH_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then date_ticket END) AS MAXDTE_KH_Glb
    ,COUNT(DISTINCT CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then CODE_CLIENT end) AS nb_clt_KH
    ,COUNT(DISTINCT CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then id_ticket END) AS nb_ticket_KH
    ,SUM(CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_TTC END) AS CA_KH
	,SUM(CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then QUANTITE_LIGNE END) AS qte_achete_KH
    ,SUM(CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_MARGE_SORTIE END) AS Marge_KH
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then CODE_CLIENT end) AS nb_clt_KH_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then id_ticket END) AS nb_ticket_KH_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_TTC END) AS CA_KH_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then QUANTITE_LIGNE END) AS qte_achete_KH_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_MARGE_SORTIE END) AS Marge_KH_Glb	
    ,COUNT(DISTINCT CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_KH           
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then date_ticket END) AS MINDTE_PK_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then date_ticket END) AS MAXDTE_PK_Glb
    ,COUNT(DISTINCT CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then CODE_CLIENT end) AS nb_clt_PK
    ,COUNT(DISTINCT CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then id_ticket END) AS nb_ticket_PK
    ,SUM(CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_TTC END) AS CA_PK
	,SUM(CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then QUANTITE_LIGNE END) AS qte_achete_PK
    ,SUM(CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_MARGE_SORTIE END) AS Marge_PK
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then CODE_CLIENT end) AS nb_clt_PK_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then id_ticket END) AS nb_ticket_PK_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_TTC END) AS CA_PK_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then QUANTITE_LIGNE END) AS qte_achete_PK_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_MARGE_SORTIE END) AS Marge_PK_Glb 
    ,COUNT(DISTINCT CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_PK    
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then date_ticket END) AS MINDTE_music_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then date_ticket END) AS MAXDTE_music_Glb
    ,COUNT(DISTINCT CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then CODE_CLIENT end) AS nb_clt_music
    ,COUNT(DISTINCT CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then id_ticket END) AS nb_ticket_music
    ,SUM(CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_TTC END) AS CA_music
	,SUM(CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then QUANTITE_LIGNE END) AS qte_achete_music
    ,SUM(CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_MARGE_SORTIE END) AS Marge_music
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then CODE_CLIENT end) AS nb_clt_music_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then id_ticket END) AS nb_ticket_music_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_TTC END) AS CA_music_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then QUANTITE_LIGNE END) AS qte_achete_music_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_MARGE_SORTIE END) AS Marge_music_Glb
    ,COUNT(DISTINCT CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_music        
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then date_ticket END) AS MINDTE_smiley_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then date_ticket END) AS MAXDTE_smiley_Glb
    ,COUNT(DISTINCT CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then CODE_CLIENT end) AS nb_clt_smiley
    ,COUNT(DISTINCT CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then id_ticket END) AS nb_ticket_smiley
    ,SUM(CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_TTC END) AS CA_smiley
	,SUM(CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then QUANTITE_LIGNE END) AS qte_achete_smiley
    ,SUM(CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_MARGE_SORTIE END) AS Marge_smiley
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then CODE_CLIENT end) AS nb_clt_smiley_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then id_ticket END) AS nb_ticket_smiley_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_TTC END) AS CA_smiley_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then QUANTITE_LIGNE END) AS qte_achete_smiley_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_MARGE_SORTIE END) AS Marge_smiley_Glb
    ,COUNT(DISTINCT CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_smiley
FROM DATA_MESH_PROD_CLIENT.WORK.BASE_INFOCLT_CAPSULES_V2
GROUP BY 1,2
UNION
SELECT '04_SEGMENT_RFM' AS typo_clt,  SEGMENT_RFM AS modalite
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then date_ticket END) AS MINDTE_KH_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then date_ticket END) AS MAXDTE_KH_Glb
    ,COUNT(DISTINCT CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then CODE_CLIENT end) AS nb_clt_KH
    ,COUNT(DISTINCT CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then id_ticket END) AS nb_ticket_KH
    ,SUM(CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_TTC END) AS CA_KH
	,SUM(CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then QUANTITE_LIGNE END) AS qte_achete_KH
    ,SUM(CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_MARGE_SORTIE END) AS Marge_KH
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then CODE_CLIENT end) AS nb_clt_KH_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then id_ticket END) AS nb_ticket_KH_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_TTC END) AS CA_KH_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then QUANTITE_LIGNE END) AS qte_achete_KH_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_MARGE_SORTIE END) AS Marge_KH_Glb	
    ,COUNT(DISTINCT CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_KH           
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then date_ticket END) AS MINDTE_PK_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then date_ticket END) AS MAXDTE_PK_Glb
    ,COUNT(DISTINCT CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then CODE_CLIENT end) AS nb_clt_PK
    ,COUNT(DISTINCT CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then id_ticket END) AS nb_ticket_PK
    ,SUM(CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_TTC END) AS CA_PK
	,SUM(CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then QUANTITE_LIGNE END) AS qte_achete_PK
    ,SUM(CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_MARGE_SORTIE END) AS Marge_PK
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then CODE_CLIENT end) AS nb_clt_PK_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then id_ticket END) AS nb_ticket_PK_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_TTC END) AS CA_PK_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then QUANTITE_LIGNE END) AS qte_achete_PK_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_MARGE_SORTIE END) AS Marge_PK_Glb 
    ,COUNT(DISTINCT CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_PK    
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then date_ticket END) AS MINDTE_music_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then date_ticket END) AS MAXDTE_music_Glb
    ,COUNT(DISTINCT CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then CODE_CLIENT end) AS nb_clt_music
    ,COUNT(DISTINCT CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then id_ticket END) AS nb_ticket_music
    ,SUM(CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_TTC END) AS CA_music
	,SUM(CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then QUANTITE_LIGNE END) AS qte_achete_music
    ,SUM(CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_MARGE_SORTIE END) AS Marge_music
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then CODE_CLIENT end) AS nb_clt_music_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then id_ticket END) AS nb_ticket_music_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_TTC END) AS CA_music_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then QUANTITE_LIGNE END) AS qte_achete_music_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_MARGE_SORTIE END) AS Marge_music_Glb
    ,COUNT(DISTINCT CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_music        
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then date_ticket END) AS MINDTE_smiley_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then date_ticket END) AS MAXDTE_smiley_Glb
    ,COUNT(DISTINCT CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then CODE_CLIENT end) AS nb_clt_smiley
    ,COUNT(DISTINCT CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then id_ticket END) AS nb_ticket_smiley
    ,SUM(CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_TTC END) AS CA_smiley
	,SUM(CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then QUANTITE_LIGNE END) AS qte_achete_smiley
    ,SUM(CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_MARGE_SORTIE END) AS Marge_smiley
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then CODE_CLIENT end) AS nb_clt_smiley_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then id_ticket END) AS nb_ticket_smiley_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_TTC END) AS CA_smiley_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then QUANTITE_LIGNE END) AS qte_achete_smiley_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_MARGE_SORTIE END) AS Marge_smiley_Glb
    ,COUNT(DISTINCT CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_smiley
FROM DATA_MESH_PROD_CLIENT.WORK.BASE_INFOCLT_CAPSULES_V2
GROUP BY 1,2
UNION
SELECT '05_OMNICANALITE' AS typo_clt, 
 CASE WHEN lib_segment_omni ='MAG' then '01-MAG' 
      When lib_segment_omni ='WEB' then '02-WEB'
      When lib_segment_omni ='OMNI' then '03-OMNI' ELSE '99-NON RENSEIGNE' end as modalite
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then date_ticket END) AS MINDTE_KH_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then date_ticket END) AS MAXDTE_KH_Glb
    ,COUNT(DISTINCT CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then CODE_CLIENT end) AS nb_clt_KH
    ,COUNT(DISTINCT CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then id_ticket END) AS nb_ticket_KH
    ,SUM(CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_TTC END) AS CA_KH
	,SUM(CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then QUANTITE_LIGNE END) AS qte_achete_KH
    ,SUM(CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_MARGE_SORTIE END) AS Marge_KH
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then CODE_CLIENT end) AS nb_clt_KH_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then id_ticket END) AS nb_ticket_KH_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_TTC END) AS CA_KH_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then QUANTITE_LIGNE END) AS qte_achete_KH_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_MARGE_SORTIE END) AS Marge_KH_Glb	
    ,COUNT(DISTINCT CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_KH           
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then date_ticket END) AS MINDTE_PK_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then date_ticket END) AS MAXDTE_PK_Glb
    ,COUNT(DISTINCT CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then CODE_CLIENT end) AS nb_clt_PK
    ,COUNT(DISTINCT CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then id_ticket END) AS nb_ticket_PK
    ,SUM(CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_TTC END) AS CA_PK
	,SUM(CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then QUANTITE_LIGNE END) AS qte_achete_PK
    ,SUM(CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_MARGE_SORTIE END) AS Marge_PK
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then CODE_CLIENT end) AS nb_clt_PK_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then id_ticket END) AS nb_ticket_PK_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_TTC END) AS CA_PK_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then QUANTITE_LIGNE END) AS qte_achete_PK_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_MARGE_SORTIE END) AS Marge_PK_Glb 
    ,COUNT(DISTINCT CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_PK    
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then date_ticket END) AS MINDTE_music_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then date_ticket END) AS MAXDTE_music_Glb
    ,COUNT(DISTINCT CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then CODE_CLIENT end) AS nb_clt_music
    ,COUNT(DISTINCT CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then id_ticket END) AS nb_ticket_music
    ,SUM(CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_TTC END) AS CA_music
	,SUM(CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then QUANTITE_LIGNE END) AS qte_achete_music
    ,SUM(CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_MARGE_SORTIE END) AS Marge_music
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then CODE_CLIENT end) AS nb_clt_music_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then id_ticket END) AS nb_ticket_music_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_TTC END) AS CA_music_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then QUANTITE_LIGNE END) AS qte_achete_music_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_MARGE_SORTIE END) AS Marge_music_Glb
    ,COUNT(DISTINCT CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_music        
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then date_ticket END) AS MINDTE_smiley_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then date_ticket END) AS MAXDTE_smiley_Glb
    ,COUNT(DISTINCT CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then CODE_CLIENT end) AS nb_clt_smiley
    ,COUNT(DISTINCT CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then id_ticket END) AS nb_ticket_smiley
    ,SUM(CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_TTC END) AS CA_smiley
	,SUM(CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then QUANTITE_LIGNE END) AS qte_achete_smiley
    ,SUM(CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_MARGE_SORTIE END) AS Marge_smiley
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then CODE_CLIENT end) AS nb_clt_smiley_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then id_ticket END) AS nb_ticket_smiley_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_TTC END) AS CA_smiley_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then QUANTITE_LIGNE END) AS qte_achete_smiley_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_MARGE_SORTIE END) AS Marge_smiley_Glb
    ,COUNT(DISTINCT CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_smiley
FROM DATA_MESH_PROD_CLIENT.WORK.BASE_INFOCLT_CAPSULES_V2
GROUP BY 1,2	  
UNION
SELECT '06_CANAL_ACHAT' AS typo_clt, 
 CASE WHEN type_emplacement IN ('EC','MP') THEN 'WEB'
WHEN type_emplacement IN ('PAC','CC', 'CV','CCV') THEN 'MAG' END AS modalite
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then date_ticket END) AS MINDTE_KH_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then date_ticket END) AS MAXDTE_KH_Glb
    ,COUNT(DISTINCT CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then CODE_CLIENT end) AS nb_clt_KH
    ,COUNT(DISTINCT CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then id_ticket END) AS nb_ticket_KH
    ,SUM(CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_TTC END) AS CA_KH
	,SUM(CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then QUANTITE_LIGNE END) AS qte_achete_KH
    ,SUM(CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_MARGE_SORTIE END) AS Marge_KH
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then CODE_CLIENT end) AS nb_clt_KH_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then id_ticket END) AS nb_ticket_KH_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_TTC END) AS CA_KH_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then QUANTITE_LIGNE END) AS qte_achete_KH_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_MARGE_SORTIE END) AS Marge_KH_Glb	
    ,COUNT(DISTINCT CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_KH           
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then date_ticket END) AS MINDTE_PK_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then date_ticket END) AS MAXDTE_PK_Glb
    ,COUNT(DISTINCT CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then CODE_CLIENT end) AS nb_clt_PK
    ,COUNT(DISTINCT CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then id_ticket END) AS nb_ticket_PK
    ,SUM(CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_TTC END) AS CA_PK
	,SUM(CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then QUANTITE_LIGNE END) AS qte_achete_PK
    ,SUM(CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_MARGE_SORTIE END) AS Marge_PK
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then CODE_CLIENT end) AS nb_clt_PK_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then id_ticket END) AS nb_ticket_PK_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_TTC END) AS CA_PK_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then QUANTITE_LIGNE END) AS qte_achete_PK_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_MARGE_SORTIE END) AS Marge_PK_Glb 
    ,COUNT(DISTINCT CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_PK    
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then date_ticket END) AS MINDTE_music_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then date_ticket END) AS MAXDTE_music_Glb
    ,COUNT(DISTINCT CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then CODE_CLIENT end) AS nb_clt_music
    ,COUNT(DISTINCT CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then id_ticket END) AS nb_ticket_music
    ,SUM(CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_TTC END) AS CA_music
	,SUM(CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then QUANTITE_LIGNE END) AS qte_achete_music
    ,SUM(CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_MARGE_SORTIE END) AS Marge_music
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then CODE_CLIENT end) AS nb_clt_music_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then id_ticket END) AS nb_ticket_music_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_TTC END) AS CA_music_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then QUANTITE_LIGNE END) AS qte_achete_music_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_MARGE_SORTIE END) AS Marge_music_Glb
    ,COUNT(DISTINCT CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_music        
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then date_ticket END) AS MINDTE_smiley_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then date_ticket END) AS MAXDTE_smiley_Glb
    ,COUNT(DISTINCT CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then CODE_CLIENT end) AS nb_clt_smiley
    ,COUNT(DISTINCT CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then id_ticket END) AS nb_ticket_smiley
    ,SUM(CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_TTC END) AS CA_smiley
	,SUM(CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then QUANTITE_LIGNE END) AS qte_achete_smiley
    ,SUM(CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_MARGE_SORTIE END) AS Marge_smiley
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then CODE_CLIENT end) AS nb_clt_smiley_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then id_ticket END) AS nb_ticket_smiley_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_TTC END) AS CA_smiley_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then QUANTITE_LIGNE END) AS qte_achete_smiley_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_MARGE_SORTIE END) AS Marge_smiley_Glb
    ,COUNT(DISTINCT CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_smiley
FROM DATA_MESH_PROD_CLIENT.WORK.BASE_INFOCLT_CAPSULES_V2
GROUP BY 1,2
UNION
SELECT '07A_ANCIENNETE CLIENT' AS typo_clt,  Tr_anciennete AS modalite
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then date_ticket END) AS MINDTE_KH_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then date_ticket END) AS MAXDTE_KH_Glb
    ,COUNT(DISTINCT CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then CODE_CLIENT end) AS nb_clt_KH
    ,COUNT(DISTINCT CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then id_ticket END) AS nb_ticket_KH
    ,SUM(CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_TTC END) AS CA_KH
	,SUM(CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then QUANTITE_LIGNE END) AS qte_achete_KH
    ,SUM(CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_MARGE_SORTIE END) AS Marge_KH
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then CODE_CLIENT end) AS nb_clt_KH_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then id_ticket END) AS nb_ticket_KH_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_TTC END) AS CA_KH_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then QUANTITE_LIGNE END) AS qte_achete_KH_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_MARGE_SORTIE END) AS Marge_KH_Glb	
    ,COUNT(DISTINCT CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_KH           
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then date_ticket END) AS MINDTE_PK_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then date_ticket END) AS MAXDTE_PK_Glb
    ,COUNT(DISTINCT CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then CODE_CLIENT end) AS nb_clt_PK
    ,COUNT(DISTINCT CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then id_ticket END) AS nb_ticket_PK
    ,SUM(CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_TTC END) AS CA_PK
	,SUM(CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then QUANTITE_LIGNE END) AS qte_achete_PK
    ,SUM(CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_MARGE_SORTIE END) AS Marge_PK
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then CODE_CLIENT end) AS nb_clt_PK_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then id_ticket END) AS nb_ticket_PK_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_TTC END) AS CA_PK_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then QUANTITE_LIGNE END) AS qte_achete_PK_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_MARGE_SORTIE END) AS Marge_PK_Glb 
    ,COUNT(DISTINCT CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_PK    
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then date_ticket END) AS MINDTE_music_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then date_ticket END) AS MAXDTE_music_Glb
    ,COUNT(DISTINCT CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then CODE_CLIENT end) AS nb_clt_music
    ,COUNT(DISTINCT CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then id_ticket END) AS nb_ticket_music
    ,SUM(CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_TTC END) AS CA_music
	,SUM(CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then QUANTITE_LIGNE END) AS qte_achete_music
    ,SUM(CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_MARGE_SORTIE END) AS Marge_music
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then CODE_CLIENT end) AS nb_clt_music_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then id_ticket END) AS nb_ticket_music_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_TTC END) AS CA_music_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then QUANTITE_LIGNE END) AS qte_achete_music_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_MARGE_SORTIE END) AS Marge_music_Glb
    ,COUNT(DISTINCT CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_music        
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then date_ticket END) AS MINDTE_smiley_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then date_ticket END) AS MAXDTE_smiley_Glb
    ,COUNT(DISTINCT CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then CODE_CLIENT end) AS nb_clt_smiley
    ,COUNT(DISTINCT CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then id_ticket END) AS nb_ticket_smiley
    ,SUM(CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_TTC END) AS CA_smiley
	,SUM(CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then QUANTITE_LIGNE END) AS qte_achete_smiley
    ,SUM(CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_MARGE_SORTIE END) AS Marge_smiley
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then CODE_CLIENT end) AS nb_clt_smiley_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then id_ticket END) AS nb_ticket_smiley_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_TTC END) AS CA_smiley_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then QUANTITE_LIGNE END) AS qte_achete_smiley_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_MARGE_SORTIE END) AS Marge_smiley_Glb
    ,COUNT(DISTINCT CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_smiley
FROM DATA_MESH_PROD_CLIENT.WORK.BASE_INFOCLT_CAPSULES_V2
GROUP BY 1,2
UNION 
SELECT '07B_ANCIENNETE Moyenne' AS typo_clt,  'ANCIENNETE Moyenne' AS modalite
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then date_ticket END) AS MINDTE_KH_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then date_ticket END) AS MAXDTE_KH_Glb
    ,AVG( CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then anciennete_client end) AS nb_clt_KH
    ,AVG( CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then anciennete_client END) AS nb_ticket_KH
    ,AVG(CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then anciennete_client END) AS CA_KH
	,AVG(CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then anciennete_client END) AS qte_achete_KH
    ,AVG(CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then anciennete_client END) AS Marge_KH
    ,AVG( CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then anciennete_client end) AS nb_clt_KH_Glb
    ,AVG( CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then anciennete_client END) AS nb_ticket_KH_Glb
    ,AVG(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then anciennete_client END) AS CA_KH_Glb
	,AVG(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then anciennete_client END) AS qte_achete_KH_Glb
    ,AVG(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then anciennete_client END) AS Marge_KH_Glb	
    ,AVG( CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 AND Date(date_recrutement)=Date(date_ticket) then anciennete_client end) AS nb_newclt_KH           
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then date_ticket END) AS MINDTE_PK_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then date_ticket END) AS MAXDTE_PK_Glb
    ,AVG( CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then anciennete_client end) AS nb_clt_PK
    ,AVG( CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then anciennete_client END) AS nb_ticket_PK
    ,AVG(CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then anciennete_client END) AS CA_PK
	,AVG(CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then anciennete_client END) AS qte_achete_PK
    ,AVG(CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then anciennete_client END) AS Marge_PK
    ,AVG( CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then anciennete_client end) AS nb_clt_PK_Glb
    ,AVG( CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then anciennete_client END) AS nb_ticket_PK_Glb
    ,AVG(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then anciennete_client END) AS CA_PK_Glb
	,AVG(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then anciennete_client END) AS qte_achete_PK_Glb
    ,AVG(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then anciennete_client END) AS Marge_PK_Glb 
    ,AVG( CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 AND Date(date_recrutement)=Date(date_ticket) then anciennete_client end) AS nb_newclt_PK    
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then date_ticket END) AS MINDTE_music_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then date_ticket END) AS MAXDTE_music_Glb
    ,AVG( CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then anciennete_client end) AS nb_clt_music
    ,AVG( CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then anciennete_client END) AS nb_ticket_music
    ,AVG(CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then anciennete_client END) AS CA_music
	,AVG(CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then anciennete_client END) AS qte_achete_music
    ,AVG(CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then anciennete_client END) AS Marge_music
    ,AVG( CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then anciennete_client end) AS nb_clt_music_Glb
    ,AVG( CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then anciennete_client END) AS nb_ticket_music_Glb
    ,AVG(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then anciennete_client END) AS CA_music_Glb
	,AVG(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then anciennete_client END) AS qte_achete_music_Glb
    ,AVG(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then anciennete_client END) AS Marge_music_Glb
    ,AVG( CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 AND Date(date_recrutement)=Date(date_ticket) then anciennete_client end) AS nb_newclt_music        
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then date_ticket END) AS MINDTE_smiley_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then date_ticket END) AS MAXDTE_smiley_Glb
    ,AVG( CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then anciennete_client end) AS nb_clt_smiley
    ,AVG( CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then anciennete_client END) AS nb_ticket_smiley
    ,AVG(CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then anciennete_client END) AS CA_smiley
	,AVG(CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then anciennete_client END) AS qte_achete_smiley
    ,AVG(CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then anciennete_client END) AS Marge_smiley
    ,AVG( CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then anciennete_client end) AS nb_clt_smiley_Glb
    ,AVG( CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then anciennete_client END) AS nb_ticket_smiley_Glb
    ,AVG(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then anciennete_client END) AS CA_smiley_Glb
	,AVG(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then anciennete_client END) AS qte_achete_smiley_Glb
    ,AVG(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then anciennete_client END) AS Marge_smiley_Glb
    ,AVG( CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 AND Date(date_recrutement)=Date(date_ticket) then anciennete_client end) AS nb_newclt_smiley
FROM DATA_MESH_PROD_CLIENT.WORK.BASE_INFOCLT_CAPSULES_V2
GROUP BY 1,2
UNION
SELECT '08_AGE' AS typo_clt,  CLASSE_AGE AS modalite
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then date_ticket END) AS MINDTE_KH_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then date_ticket END) AS MAXDTE_KH_Glb
    ,COUNT(DISTINCT CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then CODE_CLIENT end) AS nb_clt_KH
    ,COUNT(DISTINCT CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then id_ticket END) AS nb_ticket_KH
    ,SUM(CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_TTC END) AS CA_KH
	,SUM(CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then QUANTITE_LIGNE END) AS qte_achete_KH
    ,SUM(CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_MARGE_SORTIE END) AS Marge_KH
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then CODE_CLIENT end) AS nb_clt_KH_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then id_ticket END) AS nb_ticket_KH_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_TTC END) AS CA_KH_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then QUANTITE_LIGNE END) AS qte_achete_KH_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_MARGE_SORTIE END) AS Marge_KH_Glb	
    ,COUNT(DISTINCT CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_KH           
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then date_ticket END) AS MINDTE_PK_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then date_ticket END) AS MAXDTE_PK_Glb
    ,COUNT(DISTINCT CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then CODE_CLIENT end) AS nb_clt_PK
    ,COUNT(DISTINCT CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then id_ticket END) AS nb_ticket_PK
    ,SUM(CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_TTC END) AS CA_PK
	,SUM(CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then QUANTITE_LIGNE END) AS qte_achete_PK
    ,SUM(CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_MARGE_SORTIE END) AS Marge_PK
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then CODE_CLIENT end) AS nb_clt_PK_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then id_ticket END) AS nb_ticket_PK_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_TTC END) AS CA_PK_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then QUANTITE_LIGNE END) AS qte_achete_PK_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_MARGE_SORTIE END) AS Marge_PK_Glb 
    ,COUNT(DISTINCT CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_PK    
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then date_ticket END) AS MINDTE_music_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then date_ticket END) AS MAXDTE_music_Glb
    ,COUNT(DISTINCT CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then CODE_CLIENT end) AS nb_clt_music
    ,COUNT(DISTINCT CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then id_ticket END) AS nb_ticket_music
    ,SUM(CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_TTC END) AS CA_music
	,SUM(CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then QUANTITE_LIGNE END) AS qte_achete_music
    ,SUM(CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_MARGE_SORTIE END) AS Marge_music
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then CODE_CLIENT end) AS nb_clt_music_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then id_ticket END) AS nb_ticket_music_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_TTC END) AS CA_music_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then QUANTITE_LIGNE END) AS qte_achete_music_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_MARGE_SORTIE END) AS Marge_music_Glb
    ,COUNT(DISTINCT CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_music        
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then date_ticket END) AS MINDTE_smiley_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then date_ticket END) AS MAXDTE_smiley_Glb
    ,COUNT(DISTINCT CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then CODE_CLIENT end) AS nb_clt_smiley
    ,COUNT(DISTINCT CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then id_ticket END) AS nb_ticket_smiley
    ,SUM(CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_TTC END) AS CA_smiley
	,SUM(CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then QUANTITE_LIGNE END) AS qte_achete_smiley
    ,SUM(CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_MARGE_SORTIE END) AS Marge_smiley
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then CODE_CLIENT end) AS nb_clt_smiley_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then id_ticket END) AS nb_ticket_smiley_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_TTC END) AS CA_smiley_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then QUANTITE_LIGNE END) AS qte_achete_smiley_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_MARGE_SORTIE END) AS Marge_smiley_Glb
    ,COUNT(DISTINCT CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_smiley
FROM DATA_MESH_PROD_CLIENT.WORK.BASE_INFOCLT_CAPSULES_V2
GROUP BY 1,2 
UNION
SELECT '09_OPTIN_SMS' AS typo_clt,  CASE WHEN est_optin_sms_com=1 or est_optin_sms_fid=1 THEN '01_OUI' ELSE '02_NON' END AS modalite
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then date_ticket END) AS MINDTE_KH_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then date_ticket END) AS MAXDTE_KH_Glb
    ,COUNT(DISTINCT CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then CODE_CLIENT end) AS nb_clt_KH
    ,COUNT(DISTINCT CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then id_ticket END) AS nb_ticket_KH
    ,SUM(CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_TTC END) AS CA_KH
	,SUM(CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then QUANTITE_LIGNE END) AS qte_achete_KH
    ,SUM(CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_MARGE_SORTIE END) AS Marge_KH
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then CODE_CLIENT end) AS nb_clt_KH_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then id_ticket END) AS nb_ticket_KH_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_TTC END) AS CA_KH_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then QUANTITE_LIGNE END) AS qte_achete_KH_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_MARGE_SORTIE END) AS Marge_KH_Glb	
    ,COUNT(DISTINCT CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_KH           
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then date_ticket END) AS MINDTE_PK_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then date_ticket END) AS MAXDTE_PK_Glb
    ,COUNT(DISTINCT CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then CODE_CLIENT end) AS nb_clt_PK
    ,COUNT(DISTINCT CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then id_ticket END) AS nb_ticket_PK
    ,SUM(CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_TTC END) AS CA_PK
	,SUM(CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then QUANTITE_LIGNE END) AS qte_achete_PK
    ,SUM(CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_MARGE_SORTIE END) AS Marge_PK
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then CODE_CLIENT end) AS nb_clt_PK_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then id_ticket END) AS nb_ticket_PK_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_TTC END) AS CA_PK_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then QUANTITE_LIGNE END) AS qte_achete_PK_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_MARGE_SORTIE END) AS Marge_PK_Glb 
    ,COUNT(DISTINCT CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_PK    
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then date_ticket END) AS MINDTE_music_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then date_ticket END) AS MAXDTE_music_Glb
    ,COUNT(DISTINCT CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then CODE_CLIENT end) AS nb_clt_music
    ,COUNT(DISTINCT CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then id_ticket END) AS nb_ticket_music
    ,SUM(CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_TTC END) AS CA_music
	,SUM(CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then QUANTITE_LIGNE END) AS qte_achete_music
    ,SUM(CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_MARGE_SORTIE END) AS Marge_music
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then CODE_CLIENT end) AS nb_clt_music_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then id_ticket END) AS nb_ticket_music_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_TTC END) AS CA_music_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then QUANTITE_LIGNE END) AS qte_achete_music_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_MARGE_SORTIE END) AS Marge_music_Glb
    ,COUNT(DISTINCT CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_music        
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then date_ticket END) AS MINDTE_smiley_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then date_ticket END) AS MAXDTE_smiley_Glb
    ,COUNT(DISTINCT CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then CODE_CLIENT end) AS nb_clt_smiley
    ,COUNT(DISTINCT CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then id_ticket END) AS nb_ticket_smiley
    ,SUM(CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_TTC END) AS CA_smiley
	,SUM(CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then QUANTITE_LIGNE END) AS qte_achete_smiley
    ,SUM(CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_MARGE_SORTIE END) AS Marge_smiley
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then CODE_CLIENT end) AS nb_clt_smiley_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then id_ticket END) AS nb_ticket_smiley_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_TTC END) AS CA_smiley_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then QUANTITE_LIGNE END) AS qte_achete_smiley_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_MARGE_SORTIE END) AS Marge_smiley_Glb
    ,COUNT(DISTINCT CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_smiley
FROM DATA_MESH_PROD_CLIENT.WORK.BASE_INFOCLT_CAPSULES_V2
GROUP BY 1,2
UNION
SELECT '10_OPTIN_EMAIL' AS typo_clt,  CASE WHEN est_optin_email_com=1 or est_optin_email_fid=1 THEN '01_OUI' ELSE '02_NON' END AS modalite
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then date_ticket END) AS MINDTE_KH_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then date_ticket END) AS MAXDTE_KH_Glb
    ,COUNT(DISTINCT CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then CODE_CLIENT end) AS nb_clt_KH
    ,COUNT(DISTINCT CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then id_ticket END) AS nb_ticket_KH
    ,SUM(CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_TTC END) AS CA_KH
	,SUM(CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then QUANTITE_LIGNE END) AS qte_achete_KH
    ,SUM(CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_MARGE_SORTIE END) AS Marge_KH
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then CODE_CLIENT end) AS nb_clt_KH_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then id_ticket END) AS nb_ticket_KH_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_TTC END) AS CA_KH_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then QUANTITE_LIGNE END) AS qte_achete_KH_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_MARGE_SORTIE END) AS Marge_KH_Glb	
    ,COUNT(DISTINCT CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_KH           
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then date_ticket END) AS MINDTE_PK_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then date_ticket END) AS MAXDTE_PK_Glb
    ,COUNT(DISTINCT CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then CODE_CLIENT end) AS nb_clt_PK
    ,COUNT(DISTINCT CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then id_ticket END) AS nb_ticket_PK
    ,SUM(CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_TTC END) AS CA_PK
	,SUM(CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then QUANTITE_LIGNE END) AS qte_achete_PK
    ,SUM(CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_MARGE_SORTIE END) AS Marge_PK
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then CODE_CLIENT end) AS nb_clt_PK_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then id_ticket END) AS nb_ticket_PK_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_TTC END) AS CA_PK_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then QUANTITE_LIGNE END) AS qte_achete_PK_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_MARGE_SORTIE END) AS Marge_PK_Glb 
    ,COUNT(DISTINCT CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_PK    
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then date_ticket END) AS MINDTE_music_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then date_ticket END) AS MAXDTE_music_Glb
    ,COUNT(DISTINCT CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then CODE_CLIENT end) AS nb_clt_music
    ,COUNT(DISTINCT CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then id_ticket END) AS nb_ticket_music
    ,SUM(CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_TTC END) AS CA_music
	,SUM(CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then QUANTITE_LIGNE END) AS qte_achete_music
    ,SUM(CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_MARGE_SORTIE END) AS Marge_music
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then CODE_CLIENT end) AS nb_clt_music_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then id_ticket END) AS nb_ticket_music_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_TTC END) AS CA_music_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then QUANTITE_LIGNE END) AS qte_achete_music_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_MARGE_SORTIE END) AS Marge_music_Glb
    ,COUNT(DISTINCT CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_music        
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then date_ticket END) AS MINDTE_smiley_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then date_ticket END) AS MAXDTE_smiley_Glb
    ,COUNT(DISTINCT CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then CODE_CLIENT end) AS nb_clt_smiley
    ,COUNT(DISTINCT CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then id_ticket END) AS nb_ticket_smiley
    ,SUM(CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_TTC END) AS CA_smiley
	,SUM(CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then QUANTITE_LIGNE END) AS qte_achete_smiley
    ,SUM(CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_MARGE_SORTIE END) AS Marge_smiley
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then CODE_CLIENT end) AS nb_clt_smiley_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then id_ticket END) AS nb_ticket_smiley_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_TTC END) AS CA_smiley_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then QUANTITE_LIGNE END) AS qte_achete_smiley_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_MARGE_SORTIE END) AS Marge_smiley_Glb
    ,COUNT(DISTINCT CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_smiley
FROM DATA_MESH_PROD_CLIENT.WORK.BASE_INFOCLT_CAPSULES_V2
GROUP BY 1,2
UNION
SELECT '11_SQUARE_SID' AS typo_clt,  SQUARE_SID_V2 AS modalite
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then date_ticket END) AS MINDTE_KH_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then date_ticket END) AS MAXDTE_KH_Glb
    ,COUNT(DISTINCT CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then CODE_CLIENT end) AS nb_clt_KH
    ,COUNT(DISTINCT CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then id_ticket END) AS nb_ticket_KH
    ,SUM(CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_TTC END) AS CA_KH
	,SUM(CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then QUANTITE_LIGNE END) AS qte_achete_KH
    ,SUM(CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_MARGE_SORTIE END) AS Marge_KH
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then CODE_CLIENT end) AS nb_clt_KH_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then id_ticket END) AS nb_ticket_KH_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_TTC END) AS CA_KH_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then QUANTITE_LIGNE END) AS qte_achete_KH_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_MARGE_SORTIE END) AS Marge_KH_Glb	
    ,COUNT(DISTINCT CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_KH           
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then date_ticket END) AS MINDTE_PK_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then date_ticket END) AS MAXDTE_PK_Glb
    ,COUNT(DISTINCT CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then CODE_CLIENT end) AS nb_clt_PK
    ,COUNT(DISTINCT CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then id_ticket END) AS nb_ticket_PK
    ,SUM(CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_TTC END) AS CA_PK
	,SUM(CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then QUANTITE_LIGNE END) AS qte_achete_PK
    ,SUM(CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_MARGE_SORTIE END) AS Marge_PK
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then CODE_CLIENT end) AS nb_clt_PK_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then id_ticket END) AS nb_ticket_PK_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_TTC END) AS CA_PK_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then QUANTITE_LIGNE END) AS qte_achete_PK_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_MARGE_SORTIE END) AS Marge_PK_Glb 
    ,COUNT(DISTINCT CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_PK    
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then date_ticket END) AS MINDTE_music_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then date_ticket END) AS MAXDTE_music_Glb
    ,COUNT(DISTINCT CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then CODE_CLIENT end) AS nb_clt_music
    ,COUNT(DISTINCT CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then id_ticket END) AS nb_ticket_music
    ,SUM(CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_TTC END) AS CA_music
	,SUM(CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then QUANTITE_LIGNE END) AS qte_achete_music
    ,SUM(CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_MARGE_SORTIE END) AS Marge_music
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then CODE_CLIENT end) AS nb_clt_music_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then id_ticket END) AS nb_ticket_music_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_TTC END) AS CA_music_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then QUANTITE_LIGNE END) AS qte_achete_music_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_MARGE_SORTIE END) AS Marge_music_Glb
    ,COUNT(DISTINCT CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_music        
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then date_ticket END) AS MINDTE_smiley_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then date_ticket END) AS MAXDTE_smiley_Glb
    ,COUNT(DISTINCT CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then CODE_CLIENT end) AS nb_clt_smiley
    ,COUNT(DISTINCT CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then id_ticket END) AS nb_ticket_smiley
    ,SUM(CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_TTC END) AS CA_smiley
	,SUM(CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then QUANTITE_LIGNE END) AS qte_achete_smiley
    ,SUM(CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_MARGE_SORTIE END) AS Marge_smiley
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then CODE_CLIENT end) AS nb_clt_smiley_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then id_ticket END) AS nb_ticket_smiley_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_TTC END) AS CA_smiley_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then QUANTITE_LIGNE END) AS qte_achete_smiley_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_MARGE_SORTIE END) AS Marge_smiley_Glb
    ,COUNT(DISTINCT CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_smiley
FROM DATA_MESH_PROD_CLIENT.WORK.BASE_INFOCLT_CAPSULES_V2
GROUP BY 1,2
UNION
SELECT '12_STORE_ACTIVITY' AS typo_clt,  STORE_ACTIVITY_V2 AS modalite
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then date_ticket END) AS MINDTE_KH_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then date_ticket END) AS MAXDTE_KH_Glb
    ,COUNT(DISTINCT CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then CODE_CLIENT end) AS nb_clt_KH
    ,COUNT(DISTINCT CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then id_ticket END) AS nb_ticket_KH
    ,SUM(CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_TTC END) AS CA_KH
	,SUM(CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then QUANTITE_LIGNE END) AS qte_achete_KH
    ,SUM(CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_MARGE_SORTIE END) AS Marge_KH
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then CODE_CLIENT end) AS nb_clt_KH_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then id_ticket END) AS nb_ticket_KH_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_TTC END) AS CA_KH_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then QUANTITE_LIGNE END) AS qte_achete_KH_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_MARGE_SORTIE END) AS Marge_KH_Glb	
    ,COUNT(DISTINCT CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_KH           
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then date_ticket END) AS MINDTE_PK_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then date_ticket END) AS MAXDTE_PK_Glb
    ,COUNT(DISTINCT CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then CODE_CLIENT end) AS nb_clt_PK
    ,COUNT(DISTINCT CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then id_ticket END) AS nb_ticket_PK
    ,SUM(CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_TTC END) AS CA_PK
	,SUM(CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then QUANTITE_LIGNE END) AS qte_achete_PK
    ,SUM(CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_MARGE_SORTIE END) AS Marge_PK
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then CODE_CLIENT end) AS nb_clt_PK_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then id_ticket END) AS nb_ticket_PK_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_TTC END) AS CA_PK_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then QUANTITE_LIGNE END) AS qte_achete_PK_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_MARGE_SORTIE END) AS Marge_PK_Glb 
    ,COUNT(DISTINCT CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_PK    
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then date_ticket END) AS MINDTE_music_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then date_ticket END) AS MAXDTE_music_Glb
    ,COUNT(DISTINCT CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then CODE_CLIENT end) AS nb_clt_music
    ,COUNT(DISTINCT CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then id_ticket END) AS nb_ticket_music
    ,SUM(CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_TTC END) AS CA_music
	,SUM(CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then QUANTITE_LIGNE END) AS qte_achete_music
    ,SUM(CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_MARGE_SORTIE END) AS Marge_music
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then CODE_CLIENT end) AS nb_clt_music_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then id_ticket END) AS nb_ticket_music_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_TTC END) AS CA_music_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then QUANTITE_LIGNE END) AS qte_achete_music_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_MARGE_SORTIE END) AS Marge_music_Glb
    ,COUNT(DISTINCT CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_music        
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then date_ticket END) AS MINDTE_smiley_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then date_ticket END) AS MAXDTE_smiley_Glb
    ,COUNT(DISTINCT CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then CODE_CLIENT end) AS nb_clt_smiley
    ,COUNT(DISTINCT CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then id_ticket END) AS nb_ticket_smiley
    ,SUM(CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_TTC END) AS CA_smiley
	,SUM(CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then QUANTITE_LIGNE END) AS qte_achete_smiley
    ,SUM(CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_MARGE_SORTIE END) AS Marge_smiley
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then CODE_CLIENT end) AS nb_clt_smiley_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then id_ticket END) AS nb_ticket_smiley_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_TTC END) AS CA_smiley_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then QUANTITE_LIGNE END) AS qte_achete_smiley_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_MARGE_SORTIE END) AS Marge_smiley_Glb
    ,COUNT(DISTINCT CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_smiley
FROM DATA_MESH_PROD_CLIENT.WORK.BASE_INFOCLT_CAPSULES_V2
GROUP BY 1,2
UNION
SELECT '13_ZONE_ACTIVITY_STATUS_V2' AS typo_clt,  ZONE_ACTIVITY_STATUS_V2 AS modalite
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then date_ticket END) AS MINDTE_KH_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then date_ticket END) AS MAXDTE_KH_Glb
    ,COUNT(DISTINCT CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then CODE_CLIENT end) AS nb_clt_KH
    ,COUNT(DISTINCT CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then id_ticket END) AS nb_ticket_KH
    ,SUM(CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_TTC END) AS CA_KH
	,SUM(CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then QUANTITE_LIGNE END) AS qte_achete_KH
    ,SUM(CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_MARGE_SORTIE END) AS Marge_KH
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then CODE_CLIENT end) AS nb_clt_KH_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then id_ticket END) AS nb_ticket_KH_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_TTC END) AS CA_KH_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then QUANTITE_LIGNE END) AS qte_achete_KH_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_MARGE_SORTIE END) AS Marge_KH_Glb	
    ,COUNT(DISTINCT CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_KH           
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then date_ticket END) AS MINDTE_PK_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then date_ticket END) AS MAXDTE_PK_Glb
    ,COUNT(DISTINCT CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then CODE_CLIENT end) AS nb_clt_PK
    ,COUNT(DISTINCT CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then id_ticket END) AS nb_ticket_PK
    ,SUM(CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_TTC END) AS CA_PK
	,SUM(CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then QUANTITE_LIGNE END) AS qte_achete_PK
    ,SUM(CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_MARGE_SORTIE END) AS Marge_PK
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then CODE_CLIENT end) AS nb_clt_PK_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then id_ticket END) AS nb_ticket_PK_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_TTC END) AS CA_PK_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then QUANTITE_LIGNE END) AS qte_achete_PK_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_MARGE_SORTIE END) AS Marge_PK_Glb 
    ,COUNT(DISTINCT CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_PK    
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then date_ticket END) AS MINDTE_music_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then date_ticket END) AS MAXDTE_music_Glb
    ,COUNT(DISTINCT CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then CODE_CLIENT end) AS nb_clt_music
    ,COUNT(DISTINCT CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then id_ticket END) AS nb_ticket_music
    ,SUM(CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_TTC END) AS CA_music
	,SUM(CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then QUANTITE_LIGNE END) AS qte_achete_music
    ,SUM(CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_MARGE_SORTIE END) AS Marge_music
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then CODE_CLIENT end) AS nb_clt_music_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then id_ticket END) AS nb_ticket_music_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_TTC END) AS CA_music_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then QUANTITE_LIGNE END) AS qte_achete_music_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_MARGE_SORTIE END) AS Marge_music_Glb
    ,COUNT(DISTINCT CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_music        
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then date_ticket END) AS MINDTE_smiley_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then date_ticket END) AS MAXDTE_smiley_Glb
    ,COUNT(DISTINCT CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then CODE_CLIENT end) AS nb_clt_smiley
    ,COUNT(DISTINCT CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then id_ticket END) AS nb_ticket_smiley
    ,SUM(CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_TTC END) AS CA_smiley
	,SUM(CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then QUANTITE_LIGNE END) AS qte_achete_smiley
    ,SUM(CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_MARGE_SORTIE END) AS Marge_smiley
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then CODE_CLIENT end) AS nb_clt_smiley_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then id_ticket END) AS nb_ticket_smiley_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_TTC END) AS CA_smiley_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then QUANTITE_LIGNE END) AS qte_achete_smiley_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_MARGE_SORTIE END) AS Marge_smiley_Glb
    ,COUNT(DISTINCT CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_smiley
FROM DATA_MESH_PROD_CLIENT.WORK.BASE_INFOCLT_CAPSULES_V2
GROUP BY 1,2
UNION
SELECT '14_FAMILY_MATURITY_V2' AS typo_clt,  FAMILY_MATURITY_V2 AS modalite
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then date_ticket END) AS MINDTE_KH_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then date_ticket END) AS MAXDTE_KH_Glb
    ,COUNT(DISTINCT CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then CODE_CLIENT end) AS nb_clt_KH
    ,COUNT(DISTINCT CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then id_ticket END) AS nb_ticket_KH
    ,SUM(CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_TTC END) AS CA_KH
	,SUM(CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then QUANTITE_LIGNE END) AS qte_achete_KH
    ,SUM(CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_MARGE_SORTIE END) AS Marge_KH
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then CODE_CLIENT end) AS nb_clt_KH_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then id_ticket END) AS nb_ticket_KH_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_TTC END) AS CA_KH_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then QUANTITE_LIGNE END) AS qte_achete_KH_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_MARGE_SORTIE END) AS Marge_KH_Glb	
    ,COUNT(DISTINCT CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_KH           
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then date_ticket END) AS MINDTE_PK_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then date_ticket END) AS MAXDTE_PK_Glb
    ,COUNT(DISTINCT CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then CODE_CLIENT end) AS nb_clt_PK
    ,COUNT(DISTINCT CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then id_ticket END) AS nb_ticket_PK
    ,SUM(CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_TTC END) AS CA_PK
	,SUM(CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then QUANTITE_LIGNE END) AS qte_achete_PK
    ,SUM(CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_MARGE_SORTIE END) AS Marge_PK
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then CODE_CLIENT end) AS nb_clt_PK_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then id_ticket END) AS nb_ticket_PK_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_TTC END) AS CA_PK_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then QUANTITE_LIGNE END) AS qte_achete_PK_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_MARGE_SORTIE END) AS Marge_PK_Glb 
    ,COUNT(DISTINCT CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_PK    
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then date_ticket END) AS MINDTE_music_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then date_ticket END) AS MAXDTE_music_Glb
    ,COUNT(DISTINCT CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then CODE_CLIENT end) AS nb_clt_music
    ,COUNT(DISTINCT CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then id_ticket END) AS nb_ticket_music
    ,SUM(CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_TTC END) AS CA_music
	,SUM(CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then QUANTITE_LIGNE END) AS qte_achete_music
    ,SUM(CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_MARGE_SORTIE END) AS Marge_music
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then CODE_CLIENT end) AS nb_clt_music_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then id_ticket END) AS nb_ticket_music_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_TTC END) AS CA_music_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then QUANTITE_LIGNE END) AS qte_achete_music_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_MARGE_SORTIE END) AS Marge_music_Glb
    ,COUNT(DISTINCT CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_music        
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then date_ticket END) AS MINDTE_smiley_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then date_ticket END) AS MAXDTE_smiley_Glb
    ,COUNT(DISTINCT CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then CODE_CLIENT end) AS nb_clt_smiley
    ,COUNT(DISTINCT CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then id_ticket END) AS nb_ticket_smiley
    ,SUM(CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_TTC END) AS CA_smiley
	,SUM(CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then QUANTITE_LIGNE END) AS qte_achete_smiley
    ,SUM(CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_MARGE_SORTIE END) AS Marge_smiley
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then CODE_CLIENT end) AS nb_clt_smiley_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then id_ticket END) AS nb_ticket_smiley_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_TTC END) AS CA_smiley_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then QUANTITE_LIGNE END) AS qte_achete_smiley_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_MARGE_SORTIE END) AS Marge_smiley_Glb
    ,COUNT(DISTINCT CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_smiley
FROM DATA_MESH_PROD_CLIENT.WORK.BASE_INFOCLT_CAPSULES_V2
GROUP BY 1,2
UNION
SELECT '15_PRICE_V2' AS typo_clt,  PRICE_V2 AS modalite
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then date_ticket END) AS MINDTE_KH_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then date_ticket END) AS MAXDTE_KH_Glb
    ,COUNT(DISTINCT CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then CODE_CLIENT end) AS nb_clt_KH
    ,COUNT(DISTINCT CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then id_ticket END) AS nb_ticket_KH
    ,SUM(CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_TTC END) AS CA_KH
	,SUM(CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then QUANTITE_LIGNE END) AS qte_achete_KH
    ,SUM(CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_MARGE_SORTIE END) AS Marge_KH
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then CODE_CLIENT end) AS nb_clt_KH_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then id_ticket END) AS nb_ticket_KH_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_TTC END) AS CA_KH_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then QUANTITE_LIGNE END) AS qte_achete_KH_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_MARGE_SORTIE END) AS Marge_KH_Glb	
    ,COUNT(DISTINCT CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_KH           
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then date_ticket END) AS MINDTE_PK_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then date_ticket END) AS MAXDTE_PK_Glb
    ,COUNT(DISTINCT CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then CODE_CLIENT end) AS nb_clt_PK
    ,COUNT(DISTINCT CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then id_ticket END) AS nb_ticket_PK
    ,SUM(CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_TTC END) AS CA_PK
	,SUM(CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then QUANTITE_LIGNE END) AS qte_achete_PK
    ,SUM(CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_MARGE_SORTIE END) AS Marge_PK
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then CODE_CLIENT end) AS nb_clt_PK_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then id_ticket END) AS nb_ticket_PK_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_TTC END) AS CA_PK_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then QUANTITE_LIGNE END) AS qte_achete_PK_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_MARGE_SORTIE END) AS Marge_PK_Glb 
    ,COUNT(DISTINCT CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_PK    
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then date_ticket END) AS MINDTE_music_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then date_ticket END) AS MAXDTE_music_Glb
    ,COUNT(DISTINCT CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then CODE_CLIENT end) AS nb_clt_music
    ,COUNT(DISTINCT CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then id_ticket END) AS nb_ticket_music
    ,SUM(CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_TTC END) AS CA_music
	,SUM(CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then QUANTITE_LIGNE END) AS qte_achete_music
    ,SUM(CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_MARGE_SORTIE END) AS Marge_music
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then CODE_CLIENT end) AS nb_clt_music_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then id_ticket END) AS nb_ticket_music_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_TTC END) AS CA_music_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then QUANTITE_LIGNE END) AS qte_achete_music_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_MARGE_SORTIE END) AS Marge_music_Glb
    ,COUNT(DISTINCT CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_music        
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then date_ticket END) AS MINDTE_smiley_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then date_ticket END) AS MAXDTE_smiley_Glb
    ,COUNT(DISTINCT CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then CODE_CLIENT end) AS nb_clt_smiley
    ,COUNT(DISTINCT CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then id_ticket END) AS nb_ticket_smiley
    ,SUM(CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_TTC END) AS CA_smiley
	,SUM(CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then QUANTITE_LIGNE END) AS qte_achete_smiley
    ,SUM(CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_MARGE_SORTIE END) AS Marge_smiley
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then CODE_CLIENT end) AS nb_clt_smiley_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then id_ticket END) AS nb_ticket_smiley_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_TTC END) AS CA_smiley_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then QUANTITE_LIGNE END) AS qte_achete_smiley_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_MARGE_SORTIE END) AS Marge_smiley_Glb
    ,COUNT(DISTINCT CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_smiley
FROM DATA_MESH_PROD_CLIENT.WORK.BASE_INFOCLT_CAPSULES_V2
GROUP BY 1,2
UNION
SELECT '16_PROMO_V2' AS typo_clt,  PROMO_V2 AS modalite
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then date_ticket END) AS MINDTE_KH_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then date_ticket END) AS MAXDTE_KH_Glb
    ,COUNT(DISTINCT CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then CODE_CLIENT end) AS nb_clt_KH
    ,COUNT(DISTINCT CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then id_ticket END) AS nb_ticket_KH
    ,SUM(CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_TTC END) AS CA_KH
	,SUM(CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then QUANTITE_LIGNE END) AS qte_achete_KH
    ,SUM(CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_MARGE_SORTIE END) AS Marge_KH
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then CODE_CLIENT end) AS nb_clt_KH_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then id_ticket END) AS nb_ticket_KH_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_TTC END) AS CA_KH_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then QUANTITE_LIGNE END) AS qte_achete_KH_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_MARGE_SORTIE END) AS Marge_KH_Glb	
    ,COUNT(DISTINCT CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_KH           
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then date_ticket END) AS MINDTE_PK_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then date_ticket END) AS MAXDTE_PK_Glb
    ,COUNT(DISTINCT CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then CODE_CLIENT end) AS nb_clt_PK
    ,COUNT(DISTINCT CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then id_ticket END) AS nb_ticket_PK
    ,SUM(CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_TTC END) AS CA_PK
	,SUM(CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then QUANTITE_LIGNE END) AS qte_achete_PK
    ,SUM(CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_MARGE_SORTIE END) AS Marge_PK
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then CODE_CLIENT end) AS nb_clt_PK_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then id_ticket END) AS nb_ticket_PK_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_TTC END) AS CA_PK_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then QUANTITE_LIGNE END) AS qte_achete_PK_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_MARGE_SORTIE END) AS Marge_PK_Glb 
    ,COUNT(DISTINCT CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_PK    
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then date_ticket END) AS MINDTE_music_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then date_ticket END) AS MAXDTE_music_Glb
    ,COUNT(DISTINCT CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then CODE_CLIENT end) AS nb_clt_music
    ,COUNT(DISTINCT CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then id_ticket END) AS nb_ticket_music
    ,SUM(CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_TTC END) AS CA_music
	,SUM(CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then QUANTITE_LIGNE END) AS qte_achete_music
    ,SUM(CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_MARGE_SORTIE END) AS Marge_music
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then CODE_CLIENT end) AS nb_clt_music_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then id_ticket END) AS nb_ticket_music_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_TTC END) AS CA_music_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then QUANTITE_LIGNE END) AS qte_achete_music_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_MARGE_SORTIE END) AS Marge_music_Glb
    ,COUNT(DISTINCT CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_music        
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then date_ticket END) AS MINDTE_smiley_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then date_ticket END) AS MAXDTE_smiley_Glb
    ,COUNT(DISTINCT CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then CODE_CLIENT end) AS nb_clt_smiley
    ,COUNT(DISTINCT CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then id_ticket END) AS nb_ticket_smiley
    ,SUM(CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_TTC END) AS CA_smiley
	,SUM(CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then QUANTITE_LIGNE END) AS qte_achete_smiley
    ,SUM(CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_MARGE_SORTIE END) AS Marge_smiley
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then CODE_CLIENT end) AS nb_clt_smiley_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then id_ticket END) AS nb_ticket_smiley_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_TTC END) AS CA_smiley_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then QUANTITE_LIGNE END) AS qte_achete_smiley_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_MARGE_SORTIE END) AS Marge_smiley_Glb
    ,COUNT(DISTINCT CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_smiley
FROM DATA_MESH_PROD_CLIENT.WORK.BASE_INFOCLT_CAPSULES_V2
GROUP BY 1,2
UNION
SELECT '17_LIFESTYLE_SEGMENT_V2' AS typo_clt,  LIFESTYLE_SEGMENT_V2 AS modalite
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then date_ticket END) AS MINDTE_KH_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then date_ticket END) AS MAXDTE_KH_Glb
    ,COUNT(DISTINCT CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then CODE_CLIENT end) AS nb_clt_KH
    ,COUNT(DISTINCT CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then id_ticket END) AS nb_ticket_KH
    ,SUM(CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_TTC END) AS CA_KH
	,SUM(CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then QUANTITE_LIGNE END) AS qte_achete_KH
    ,SUM(CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_MARGE_SORTIE END) AS Marge_KH
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then CODE_CLIENT end) AS nb_clt_KH_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then id_ticket END) AS nb_ticket_KH_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_TTC END) AS CA_KH_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then QUANTITE_LIGNE END) AS qte_achete_KH_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_MARGE_SORTIE END) AS Marge_KH_Glb	
    ,COUNT(DISTINCT CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_KH           
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then date_ticket END) AS MINDTE_PK_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then date_ticket END) AS MAXDTE_PK_Glb
    ,COUNT(DISTINCT CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then CODE_CLIENT end) AS nb_clt_PK
    ,COUNT(DISTINCT CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then id_ticket END) AS nb_ticket_PK
    ,SUM(CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_TTC END) AS CA_PK
	,SUM(CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then QUANTITE_LIGNE END) AS qte_achete_PK
    ,SUM(CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_MARGE_SORTIE END) AS Marge_PK
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then CODE_CLIENT end) AS nb_clt_PK_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then id_ticket END) AS nb_ticket_PK_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_TTC END) AS CA_PK_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then QUANTITE_LIGNE END) AS qte_achete_PK_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_MARGE_SORTIE END) AS Marge_PK_Glb 
    ,COUNT(DISTINCT CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_PK    
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then date_ticket END) AS MINDTE_music_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then date_ticket END) AS MAXDTE_music_Glb
    ,COUNT(DISTINCT CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then CODE_CLIENT end) AS nb_clt_music
    ,COUNT(DISTINCT CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then id_ticket END) AS nb_ticket_music
    ,SUM(CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_TTC END) AS CA_music
	,SUM(CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then QUANTITE_LIGNE END) AS qte_achete_music
    ,SUM(CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_MARGE_SORTIE END) AS Marge_music
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then CODE_CLIENT end) AS nb_clt_music_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then id_ticket END) AS nb_ticket_music_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_TTC END) AS CA_music_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then QUANTITE_LIGNE END) AS qte_achete_music_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_MARGE_SORTIE END) AS Marge_music_Glb
    ,COUNT(DISTINCT CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_music        
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then date_ticket END) AS MINDTE_smiley_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then date_ticket END) AS MAXDTE_smiley_Glb
    ,COUNT(DISTINCT CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then CODE_CLIENT end) AS nb_clt_smiley
    ,COUNT(DISTINCT CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then id_ticket END) AS nb_ticket_smiley
    ,SUM(CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_TTC END) AS CA_smiley
	,SUM(CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then QUANTITE_LIGNE END) AS qte_achete_smiley
    ,SUM(CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_MARGE_SORTIE END) AS Marge_smiley
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then CODE_CLIENT end) AS nb_clt_smiley_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then id_ticket END) AS nb_ticket_smiley_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_TTC END) AS CA_smiley_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then QUANTITE_LIGNE END) AS qte_achete_smiley_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_MARGE_SORTIE END) AS Marge_smiley_Glb
    ,COUNT(DISTINCT CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_smiley
FROM DATA_MESH_PROD_CLIENT.WORK.BASE_INFOCLT_CAPSULES_V2
GROUP BY 1,2
UNION
SELECT '18_CROSSCANAL_12_V2' AS typo_clt,  CROSSCANAL_12_V2 AS modalite
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then date_ticket END) AS MINDTE_KH_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then date_ticket END) AS MAXDTE_KH_Glb
    ,COUNT(DISTINCT CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then CODE_CLIENT end) AS nb_clt_KH
    ,COUNT(DISTINCT CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then id_ticket END) AS nb_ticket_KH
    ,SUM(CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_TTC END) AS CA_KH
	,SUM(CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then QUANTITE_LIGNE END) AS qte_achete_KH
    ,SUM(CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_MARGE_SORTIE END) AS Marge_KH
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then CODE_CLIENT end) AS nb_clt_KH_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then id_ticket END) AS nb_ticket_KH_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_TTC END) AS CA_KH_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then QUANTITE_LIGNE END) AS qte_achete_KH_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_MARGE_SORTIE END) AS Marge_KH_Glb	
    ,COUNT(DISTINCT CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_KH           
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then date_ticket END) AS MINDTE_PK_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then date_ticket END) AS MAXDTE_PK_Glb
    ,COUNT(DISTINCT CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then CODE_CLIENT end) AS nb_clt_PK
    ,COUNT(DISTINCT CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then id_ticket END) AS nb_ticket_PK
    ,SUM(CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_TTC END) AS CA_PK
	,SUM(CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then QUANTITE_LIGNE END) AS qte_achete_PK
    ,SUM(CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_MARGE_SORTIE END) AS Marge_PK
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then CODE_CLIENT end) AS nb_clt_PK_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then id_ticket END) AS nb_ticket_PK_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_TTC END) AS CA_PK_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then QUANTITE_LIGNE END) AS qte_achete_PK_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_MARGE_SORTIE END) AS Marge_PK_Glb 
    ,COUNT(DISTINCT CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_PK    
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then date_ticket END) AS MINDTE_music_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then date_ticket END) AS MAXDTE_music_Glb
    ,COUNT(DISTINCT CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then CODE_CLIENT end) AS nb_clt_music
    ,COUNT(DISTINCT CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then id_ticket END) AS nb_ticket_music
    ,SUM(CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_TTC END) AS CA_music
	,SUM(CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then QUANTITE_LIGNE END) AS qte_achete_music
    ,SUM(CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_MARGE_SORTIE END) AS Marge_music
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then CODE_CLIENT end) AS nb_clt_music_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then id_ticket END) AS nb_ticket_music_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_TTC END) AS CA_music_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then QUANTITE_LIGNE END) AS qte_achete_music_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_MARGE_SORTIE END) AS Marge_music_Glb
    ,COUNT(DISTINCT CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_music        
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then date_ticket END) AS MINDTE_smiley_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then date_ticket END) AS MAXDTE_smiley_Glb
    ,COUNT(DISTINCT CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then CODE_CLIENT end) AS nb_clt_smiley
    ,COUNT(DISTINCT CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then id_ticket END) AS nb_ticket_smiley
    ,SUM(CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_TTC END) AS CA_smiley
	,SUM(CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then QUANTITE_LIGNE END) AS qte_achete_smiley
    ,SUM(CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_MARGE_SORTIE END) AS Marge_smiley
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then CODE_CLIENT end) AS nb_clt_smiley_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then id_ticket END) AS nb_ticket_smiley_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_TTC END) AS CA_smiley_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then QUANTITE_LIGNE END) AS qte_achete_smiley_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_MARGE_SORTIE END) AS Marge_smiley_Glb
    ,COUNT(DISTINCT CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_smiley
FROM DATA_MESH_PROD_CLIENT.WORK.BASE_INFOCLT_CAPSULES_V2
GROUP BY 1,2
UNION
SELECT '19_CSR_ENVIRONMENT_V2' AS typo_clt,  CSR_ENVIRONMENT_V2 AS modalite
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then date_ticket END) AS MINDTE_KH_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then date_ticket END) AS MAXDTE_KH_Glb
    ,COUNT(DISTINCT CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then CODE_CLIENT end) AS nb_clt_KH
    ,COUNT(DISTINCT CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then id_ticket END) AS nb_ticket_KH
    ,SUM(CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_TTC END) AS CA_KH
	,SUM(CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then QUANTITE_LIGNE END) AS qte_achete_KH
    ,SUM(CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_MARGE_SORTIE END) AS Marge_KH
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then CODE_CLIENT end) AS nb_clt_KH_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then id_ticket END) AS nb_ticket_KH_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_TTC END) AS CA_KH_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then QUANTITE_LIGNE END) AS qte_achete_KH_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_MARGE_SORTIE END) AS Marge_KH_Glb	
    ,COUNT(DISTINCT CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_KH           
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then date_ticket END) AS MINDTE_PK_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then date_ticket END) AS MAXDTE_PK_Glb
    ,COUNT(DISTINCT CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then CODE_CLIENT end) AS nb_clt_PK
    ,COUNT(DISTINCT CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then id_ticket END) AS nb_ticket_PK
    ,SUM(CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_TTC END) AS CA_PK
	,SUM(CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then QUANTITE_LIGNE END) AS qte_achete_PK
    ,SUM(CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_MARGE_SORTIE END) AS Marge_PK
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then CODE_CLIENT end) AS nb_clt_PK_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then id_ticket END) AS nb_ticket_PK_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_TTC END) AS CA_PK_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then QUANTITE_LIGNE END) AS qte_achete_PK_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_MARGE_SORTIE END) AS Marge_PK_Glb 
    ,COUNT(DISTINCT CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_PK    
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then date_ticket END) AS MINDTE_music_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then date_ticket END) AS MAXDTE_music_Glb
    ,COUNT(DISTINCT CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then CODE_CLIENT end) AS nb_clt_music
    ,COUNT(DISTINCT CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then id_ticket END) AS nb_ticket_music
    ,SUM(CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_TTC END) AS CA_music
	,SUM(CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then QUANTITE_LIGNE END) AS qte_achete_music
    ,SUM(CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_MARGE_SORTIE END) AS Marge_music
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then CODE_CLIENT end) AS nb_clt_music_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then id_ticket END) AS nb_ticket_music_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_TTC END) AS CA_music_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then QUANTITE_LIGNE END) AS qte_achete_music_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_MARGE_SORTIE END) AS Marge_music_Glb
    ,COUNT(DISTINCT CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_music        
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then date_ticket END) AS MINDTE_smiley_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then date_ticket END) AS MAXDTE_smiley_Glb
    ,COUNT(DISTINCT CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then CODE_CLIENT end) AS nb_clt_smiley
    ,COUNT(DISTINCT CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then id_ticket END) AS nb_ticket_smiley
    ,SUM(CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_TTC END) AS CA_smiley
	,SUM(CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then QUANTITE_LIGNE END) AS qte_achete_smiley
    ,SUM(CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_MARGE_SORTIE END) AS Marge_smiley
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then CODE_CLIENT end) AS nb_clt_smiley_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then id_ticket END) AS nb_ticket_smiley_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_TTC END) AS CA_smiley_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then QUANTITE_LIGNE END) AS qte_achete_smiley_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_MARGE_SORTIE END) AS Marge_smiley_Glb
    ,COUNT(DISTINCT CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_smiley
FROM DATA_MESH_PROD_CLIENT.WORK.BASE_INFOCLT_CAPSULES_V2
GROUP BY 1,2
UNION
SELECT '20_CSR_HEALTHY_V2' AS typo_clt,  CSR_HEALTHY_V2 AS modalite
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then date_ticket END) AS MINDTE_KH_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then date_ticket END) AS MAXDTE_KH_Glb
    ,COUNT(DISTINCT CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then CODE_CLIENT end) AS nb_clt_KH
    ,COUNT(DISTINCT CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then id_ticket END) AS nb_ticket_KH
    ,SUM(CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_TTC END) AS CA_KH
	,SUM(CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then QUANTITE_LIGNE END) AS qte_achete_KH
    ,SUM(CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_MARGE_SORTIE END) AS Marge_KH
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then CODE_CLIENT end) AS nb_clt_KH_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then id_ticket END) AS nb_ticket_KH_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_TTC END) AS CA_KH_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then QUANTITE_LIGNE END) AS qte_achete_KH_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_MARGE_SORTIE END) AS Marge_KH_Glb	
    ,COUNT(DISTINCT CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_KH           
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then date_ticket END) AS MINDTE_PK_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then date_ticket END) AS MAXDTE_PK_Glb
    ,COUNT(DISTINCT CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then CODE_CLIENT end) AS nb_clt_PK
    ,COUNT(DISTINCT CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then id_ticket END) AS nb_ticket_PK
    ,SUM(CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_TTC END) AS CA_PK
	,SUM(CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then QUANTITE_LIGNE END) AS qte_achete_PK
    ,SUM(CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_MARGE_SORTIE END) AS Marge_PK
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then CODE_CLIENT end) AS nb_clt_PK_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then id_ticket END) AS nb_ticket_PK_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_TTC END) AS CA_PK_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then QUANTITE_LIGNE END) AS qte_achete_PK_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_MARGE_SORTIE END) AS Marge_PK_Glb 
    ,COUNT(DISTINCT CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_PK    
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then date_ticket END) AS MINDTE_music_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then date_ticket END) AS MAXDTE_music_Glb
    ,COUNT(DISTINCT CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then CODE_CLIENT end) AS nb_clt_music
    ,COUNT(DISTINCT CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then id_ticket END) AS nb_ticket_music
    ,SUM(CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_TTC END) AS CA_music
	,SUM(CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then QUANTITE_LIGNE END) AS qte_achete_music
    ,SUM(CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_MARGE_SORTIE END) AS Marge_music
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then CODE_CLIENT end) AS nb_clt_music_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then id_ticket END) AS nb_ticket_music_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_TTC END) AS CA_music_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then QUANTITE_LIGNE END) AS qte_achete_music_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_MARGE_SORTIE END) AS Marge_music_Glb
    ,COUNT(DISTINCT CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_music        
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then date_ticket END) AS MINDTE_smiley_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then date_ticket END) AS MAXDTE_smiley_Glb
    ,COUNT(DISTINCT CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then CODE_CLIENT end) AS nb_clt_smiley
    ,COUNT(DISTINCT CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then id_ticket END) AS nb_ticket_smiley
    ,SUM(CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_TTC END) AS CA_smiley
	,SUM(CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then QUANTITE_LIGNE END) AS qte_achete_smiley
    ,SUM(CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_MARGE_SORTIE END) AS Marge_smiley
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then CODE_CLIENT end) AS nb_clt_smiley_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then id_ticket END) AS nb_ticket_smiley_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_TTC END) AS CA_smiley_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then QUANTITE_LIGNE END) AS qte_achete_smiley_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_MARGE_SORTIE END) AS Marge_smiley_Glb
    ,COUNT(DISTINCT CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_smiley
FROM DATA_MESH_PROD_CLIENT.WORK.BASE_INFOCLT_CAPSULES_V2
GROUP BY 1,2
UNION
SELECT '21_CSR_ORGANIC_V2' AS typo_clt,  CSR_ORGANIC_V2 AS modalite
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then date_ticket END) AS MINDTE_KH_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then date_ticket END) AS MAXDTE_KH_Glb
    ,COUNT(DISTINCT CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then CODE_CLIENT end) AS nb_clt_KH
    ,COUNT(DISTINCT CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then id_ticket END) AS nb_ticket_KH
    ,SUM(CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_TTC END) AS CA_KH
	,SUM(CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then QUANTITE_LIGNE END) AS qte_achete_KH
    ,SUM(CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_MARGE_SORTIE END) AS Marge_KH
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then CODE_CLIENT end) AS nb_clt_KH_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then id_ticket END) AS nb_ticket_KH_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_TTC END) AS CA_KH_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then QUANTITE_LIGNE END) AS qte_achete_KH_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_MARGE_SORTIE END) AS Marge_KH_Glb	
    ,COUNT(DISTINCT CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_KH           
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then date_ticket END) AS MINDTE_PK_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then date_ticket END) AS MAXDTE_PK_Glb
    ,COUNT(DISTINCT CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then CODE_CLIENT end) AS nb_clt_PK
    ,COUNT(DISTINCT CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then id_ticket END) AS nb_ticket_PK
    ,SUM(CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_TTC END) AS CA_PK
	,SUM(CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then QUANTITE_LIGNE END) AS qte_achete_PK
    ,SUM(CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_MARGE_SORTIE END) AS Marge_PK
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then CODE_CLIENT end) AS nb_clt_PK_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then id_ticket END) AS nb_ticket_PK_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_TTC END) AS CA_PK_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then QUANTITE_LIGNE END) AS qte_achete_PK_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_MARGE_SORTIE END) AS Marge_PK_Glb 
    ,COUNT(DISTINCT CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_PK    
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then date_ticket END) AS MINDTE_music_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then date_ticket END) AS MAXDTE_music_Glb
    ,COUNT(DISTINCT CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then CODE_CLIENT end) AS nb_clt_music
    ,COUNT(DISTINCT CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then id_ticket END) AS nb_ticket_music
    ,SUM(CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_TTC END) AS CA_music
	,SUM(CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then QUANTITE_LIGNE END) AS qte_achete_music
    ,SUM(CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_MARGE_SORTIE END) AS Marge_music
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then CODE_CLIENT end) AS nb_clt_music_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then id_ticket END) AS nb_ticket_music_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_TTC END) AS CA_music_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then QUANTITE_LIGNE END) AS qte_achete_music_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_MARGE_SORTIE END) AS Marge_music_Glb
    ,COUNT(DISTINCT CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_music        
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then date_ticket END) AS MINDTE_smiley_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then date_ticket END) AS MAXDTE_smiley_Glb
    ,COUNT(DISTINCT CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then CODE_CLIENT end) AS nb_clt_smiley
    ,COUNT(DISTINCT CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then id_ticket END) AS nb_ticket_smiley
    ,SUM(CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_TTC END) AS CA_smiley
	,SUM(CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then QUANTITE_LIGNE END) AS qte_achete_smiley
    ,SUM(CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_MARGE_SORTIE END) AS Marge_smiley
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then CODE_CLIENT end) AS nb_clt_smiley_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then id_ticket END) AS nb_ticket_smiley_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_TTC END) AS CA_smiley_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then QUANTITE_LIGNE END) AS qte_achete_smiley_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_MARGE_SORTIE END) AS Marge_smiley_Glb
    ,COUNT(DISTINCT CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_smiley
FROM DATA_MESH_PROD_CLIENT.WORK.BASE_INFOCLT_CAPSULES_V2
GROUP BY 1,2
UNION
SELECT '22_ENSEIGNE' AS typo_clt,  CASE 
 	WHEN ID_ORG_ENSEIGNE = 1 THEN '01-JULES'
 	WHEN ID_ORG_ENSEIGNE = 3 THEN '02-BRICE' ELSE '03-Autres'
 END  AS modalite
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then date_ticket END) AS MINDTE_KH_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then date_ticket END) AS MAXDTE_KH_Glb
    ,COUNT(DISTINCT CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then CODE_CLIENT end) AS nb_clt_KH
    ,COUNT(DISTINCT CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then id_ticket END) AS nb_ticket_KH
    ,SUM(CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_TTC END) AS CA_KH
	,SUM(CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then QUANTITE_LIGNE END) AS qte_achete_KH
    ,SUM(CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_MARGE_SORTIE END) AS Marge_KH
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then CODE_CLIENT end) AS nb_clt_KH_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then id_ticket END) AS nb_ticket_KH_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_TTC END) AS CA_KH_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then QUANTITE_LIGNE END) AS qte_achete_KH_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_MARGE_SORTIE END) AS Marge_KH_Glb	
    ,COUNT(DISTINCT CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_KH           
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then date_ticket END) AS MINDTE_PK_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then date_ticket END) AS MAXDTE_PK_Glb
    ,COUNT(DISTINCT CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then CODE_CLIENT end) AS nb_clt_PK
    ,COUNT(DISTINCT CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then id_ticket END) AS nb_ticket_PK
    ,SUM(CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_TTC END) AS CA_PK
	,SUM(CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then QUANTITE_LIGNE END) AS qte_achete_PK
    ,SUM(CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_MARGE_SORTIE END) AS Marge_PK
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then CODE_CLIENT end) AS nb_clt_PK_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then id_ticket END) AS nb_ticket_PK_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_TTC END) AS CA_PK_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then QUANTITE_LIGNE END) AS qte_achete_PK_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_MARGE_SORTIE END) AS Marge_PK_Glb 
    ,COUNT(DISTINCT CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_PK    
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then date_ticket END) AS MINDTE_music_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then date_ticket END) AS MAXDTE_music_Glb
    ,COUNT(DISTINCT CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then CODE_CLIENT end) AS nb_clt_music
    ,COUNT(DISTINCT CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then id_ticket END) AS nb_ticket_music
    ,SUM(CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_TTC END) AS CA_music
	,SUM(CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then QUANTITE_LIGNE END) AS qte_achete_music
    ,SUM(CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_MARGE_SORTIE END) AS Marge_music
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then CODE_CLIENT end) AS nb_clt_music_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then id_ticket END) AS nb_ticket_music_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_TTC END) AS CA_music_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then QUANTITE_LIGNE END) AS qte_achete_music_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_MARGE_SORTIE END) AS Marge_music_Glb
    ,COUNT(DISTINCT CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_music        
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then date_ticket END) AS MINDTE_smiley_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then date_ticket END) AS MAXDTE_smiley_Glb
    ,COUNT(DISTINCT CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then CODE_CLIENT end) AS nb_clt_smiley
    ,COUNT(DISTINCT CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then id_ticket END) AS nb_ticket_smiley
    ,SUM(CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_TTC END) AS CA_smiley
	,SUM(CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then QUANTITE_LIGNE END) AS qte_achete_smiley
    ,SUM(CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_MARGE_SORTIE END) AS Marge_smiley
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then CODE_CLIENT end) AS nb_clt_smiley_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then id_ticket END) AS nb_ticket_smiley_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_TTC END) AS CA_smiley_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then QUANTITE_LIGNE END) AS qte_achete_smiley_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_MARGE_SORTIE END) AS Marge_smiley_Glb
    ,COUNT(DISTINCT CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_smiley
FROM DATA_MESH_PROD_CLIENT.WORK.BASE_INFOCLT_CAPSULES_V2
GROUP BY 1,2 
UNION
SELECT '23_FAMILLE_PRODUITS' AS typo_clt,  
 CASE WHEN LIB_FAMILLE_ACHAT IS NULL THEN 'Z-NC/NR' ELSE LIB_FAMILLE_ACHAT END AS modalite 
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then date_ticket END) AS MINDTE_KH_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then date_ticket END) AS MAXDTE_KH_Glb
    ,COUNT(DISTINCT CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then CODE_CLIENT end) AS nb_clt_KH
    ,COUNT(DISTINCT CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then id_ticket END) AS nb_ticket_KH
    ,SUM(CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_TTC END) AS CA_KH
	,SUM(CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then QUANTITE_LIGNE END) AS qte_achete_KH
    ,SUM(CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_MARGE_SORTIE END) AS Marge_KH
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then CODE_CLIENT end) AS nb_clt_KH_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then id_ticket END) AS nb_ticket_KH_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_TTC END) AS CA_KH_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then QUANTITE_LIGNE END) AS qte_achete_KH_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_MARGE_SORTIE END) AS Marge_KH_Glb	
    ,COUNT(DISTINCT CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_KH           
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then date_ticket END) AS MINDTE_PK_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then date_ticket END) AS MAXDTE_PK_Glb
    ,COUNT(DISTINCT CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then CODE_CLIENT end) AS nb_clt_PK
    ,COUNT(DISTINCT CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then id_ticket END) AS nb_ticket_PK
    ,SUM(CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_TTC END) AS CA_PK
	,SUM(CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then QUANTITE_LIGNE END) AS qte_achete_PK
    ,SUM(CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_MARGE_SORTIE END) AS Marge_PK
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then CODE_CLIENT end) AS nb_clt_PK_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then id_ticket END) AS nb_ticket_PK_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_TTC END) AS CA_PK_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then QUANTITE_LIGNE END) AS qte_achete_PK_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_MARGE_SORTIE END) AS Marge_PK_Glb 
    ,COUNT(DISTINCT CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_PK    
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then date_ticket END) AS MINDTE_music_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then date_ticket END) AS MAXDTE_music_Glb
    ,COUNT(DISTINCT CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then CODE_CLIENT end) AS nb_clt_music
    ,COUNT(DISTINCT CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then id_ticket END) AS nb_ticket_music
    ,SUM(CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_TTC END) AS CA_music
	,SUM(CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then QUANTITE_LIGNE END) AS qte_achete_music
    ,SUM(CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_MARGE_SORTIE END) AS Marge_music
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then CODE_CLIENT end) AS nb_clt_music_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then id_ticket END) AS nb_ticket_music_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_TTC END) AS CA_music_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then QUANTITE_LIGNE END) AS qte_achete_music_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_MARGE_SORTIE END) AS Marge_music_Glb
    ,COUNT(DISTINCT CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_music        
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then date_ticket END) AS MINDTE_smiley_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then date_ticket END) AS MAXDTE_smiley_Glb
    ,COUNT(DISTINCT CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then CODE_CLIENT end) AS nb_clt_smiley
    ,COUNT(DISTINCT CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then id_ticket END) AS nb_ticket_smiley
    ,SUM(CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_TTC END) AS CA_smiley
	,SUM(CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then QUANTITE_LIGNE END) AS qte_achete_smiley
    ,SUM(CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_MARGE_SORTIE END) AS Marge_smiley
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then CODE_CLIENT end) AS nb_clt_smiley_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then id_ticket END) AS nb_ticket_smiley_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_TTC END) AS CA_smiley_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then QUANTITE_LIGNE END) AS qte_achete_smiley_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_MARGE_SORTIE END) AS Marge_smiley_Glb
    ,COUNT(DISTINCT CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_smiley
FROM DATA_MESH_PROD_CLIENT.WORK.BASE_INFOCLT_CAPSULES_V2
GROUP BY 1,2
UNION
SELECT '24_REFCO_PRODUITS' AS typo_clt,  list_refco AS modalite 
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then date_ticket END) AS MINDTE_KH_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then date_ticket END) AS MAXDTE_KH_Glb
    ,COUNT(DISTINCT CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then CODE_CLIENT end) AS nb_clt_KH
    ,COUNT(DISTINCT CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then id_ticket END) AS nb_ticket_KH
    ,SUM(CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_TTC END) AS CA_KH
	,SUM(CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then QUANTITE_LIGNE END) AS qte_achete_KH
    ,SUM(CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_MARGE_SORTIE END) AS Marge_KH
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then CODE_CLIENT end) AS nb_clt_KH_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then id_ticket END) AS nb_ticket_KH_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_TTC END) AS CA_KH_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then QUANTITE_LIGNE END) AS qte_achete_KH_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 then MONTANT_MARGE_SORTIE END) AS Marge_KH_Glb	
    ,COUNT(DISTINCT CASE WHEN Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_KH           
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then date_ticket END) AS MINDTE_PK_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then date_ticket END) AS MAXDTE_PK_Glb
    ,COUNT(DISTINCT CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then CODE_CLIENT end) AS nb_clt_PK
    ,COUNT(DISTINCT CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then id_ticket END) AS nb_ticket_PK
    ,SUM(CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_TTC END) AS CA_PK
	,SUM(CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then QUANTITE_LIGNE END) AS qte_achete_PK
    ,SUM(CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_MARGE_SORTIE END) AS Marge_PK
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then CODE_CLIENT end) AS nb_clt_PK_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then id_ticket END) AS nb_ticket_PK_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_TTC END) AS CA_PK_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then QUANTITE_LIGNE END) AS qte_achete_PK_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 then MONTANT_MARGE_SORTIE END) AS Marge_PK_Glb 
    ,COUNT(DISTINCT CASE WHEN Top_PolaKodak =1 and date_ticket BETWEEN DATE($dtdeb_PK) AND DATE($dtfin_PK) AND tpmag_pkodak=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_PK    
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then date_ticket END) AS MINDTE_music_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then date_ticket END) AS MAXDTE_music_Glb
    ,COUNT(DISTINCT CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then CODE_CLIENT end) AS nb_clt_music
    ,COUNT(DISTINCT CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then id_ticket END) AS nb_ticket_music
    ,SUM(CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_TTC END) AS CA_music
	,SUM(CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then QUANTITE_LIGNE END) AS qte_achete_music
    ,SUM(CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_MARGE_SORTIE END) AS Marge_music
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then CODE_CLIENT end) AS nb_clt_music_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then id_ticket END) AS nb_ticket_music_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_TTC END) AS CA_music_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then QUANTITE_LIGNE END) AS qte_achete_music_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 then MONTANT_MARGE_SORTIE END) AS Marge_music_Glb
    ,COUNT(DISTINCT CASE WHEN Top_music =1 and date_ticket BETWEEN DATE($dtdeb_music) AND DATE($dtfin_music) AND tpmag_music=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_music        
 	,MIN(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then date_ticket END) AS MINDTE_smiley_Glb
    ,MAX(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then date_ticket END) AS MAXDTE_smiley_Glb
    ,COUNT(DISTINCT CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then CODE_CLIENT end) AS nb_clt_smiley
    ,COUNT(DISTINCT CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then id_ticket END) AS nb_ticket_smiley
    ,SUM(CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_TTC END) AS CA_smiley
	,SUM(CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then QUANTITE_LIGNE END) AS qte_achete_smiley
    ,SUM(CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_MARGE_SORTIE END) AS Marge_smiley
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then CODE_CLIENT end) AS nb_clt_smiley_Glb
    ,COUNT(DISTINCT CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then id_ticket END) AS nb_ticket_smiley_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_TTC END) AS CA_smiley_Glb
	,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then QUANTITE_LIGNE END) AS qte_achete_smiley_Glb
    ,SUM(CASE WHEN date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 then MONTANT_MARGE_SORTIE END) AS Marge_smiley_Glb
    ,COUNT(DISTINCT CASE WHEN Top_smiley =1 and date_ticket BETWEEN DATE($dtdeb_smiley) AND DATE($dtfin_smiley) AND tpmag_smiley=1 AND Date(date_recrutement)=Date(date_ticket) then CODE_CLIENT end) AS nb_newclt_smiley
FROM DATA_MESH_PROD_CLIENT.WORK.BASE_INFOCLT_CAPSULES_V2
GROUP BY 1,2
) 
ORDER BY 1,2; 


SELECT * FROM DATA_MESH_PROD_CLIENT.WORK.KPICLT_CAPSULES ORDER BY 1,2;

SELECT * FROM DATA_MESH_PROD_CLIENT.WORK.BASE_INFOCLT_CAPSULES
WHERE Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 ;

SELECT refco_KHARING,COUNT(DISTINCT code_client) AS nbclt
FROM DATA_MESH_PROD_CLIENT.WORK.BASE_INFOCLT_CAPSULES
WHERE Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1
GROUP BY 1; 

SELECT COUNT(DISTINCT code_client) AS nbclt
FROM DATA_MESH_PROD_CLIENT.WORK.BASE_INFOCLT_CAPSULES
WHERE Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1;


SELECT DISTINCT code_client 
FROM DATA_MESH_PROD_CLIENT.WORK.BASE_INFOCLT_CAPSULES
WHERE Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 AND refco_KHARING=0

WITH tab0 AS (SELECT code_client , SUM(refco_KHARING*1) AS S_refco_KHARING, 
Max(refco_KHARING*1) AS M_refco_KHARING
FROM DATA_MESH_PROD_CLIENT.WORK.BASE_INFOCLT_CAPSULES
WHERE Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 AND refco_KHARING=0
GROUP BY 1
HAVING S_refco_KHARING=0)
SELECT * 
FROM DATA_MESH_PROD_CLIENT.WORK.BASE_INFOCLT_CAPSULES
WHERE Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1
AND code_client IN ( SELECT DISTINCT code_client FROM tab0)


CREATE OR REPLACE TEMPORARY TABLE DATA_MESH_PROD_CLIENT.WORK.test_clt_sml AS 
WITH 
tab1 AS (SELECT code_client, 1 AS r_KHARING_1
FROM DATA_MESH_PROD_CLIENT.WORK.BASE_INFOCLT_CAPSULES
WHERE Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 AND refco_KHARING=1), 
tab2 AS (SELECT DISTINCT code_client, 1 AS r_KHARING
FROM DATA_MESH_PROD_CLIENT.WORK.BASE_INFOCLT_CAPSULES
WHERE Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 )
SELECT COALESCE (a.code_client, b.code_client) AS id_client,r_KHARING, r_KHARING_1
FROM tab2 a
FULL JOIN tab1 b ON a.code_client=b.code_client ; 

SELECT * FROM DATA_MESH_PROD_CLIENT.WORK.test_clt_sml;

SELECT *
FROM DATA_MESH_PROD_CLIENT.WORK.BASE_INFOCLT_CAPSULES
WHERE 
Top_KHARING =1 and date_ticket BETWEEN DATE($dtdeb_KH) AND DATE($dtfin_KH) AND tpmag_K_Haring=1 
AND 
CODE_CLIENT ='020410020907';


100196915468
100419311863